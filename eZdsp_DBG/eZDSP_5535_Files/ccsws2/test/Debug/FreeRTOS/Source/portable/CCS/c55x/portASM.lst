TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    1

    1424              ; Temporary Registers Used: None
       1              ; .cdecls C, LIST, "FreeRTOSConfig.h"
       2              ;  .include "FreeRTOSConfig.h"
       3              ; 32-bit stack slow mode
       4                      .mmregs
       5                       .C54CM_off
       6              ;     .CPL_off
       7                    .ARMS_off
       8                       .align 4
       9              ;       .c28_amode
      10              
      11                           .global _usCriticalNesting
      12                           .global _save_xsp
      13                           .global _Ssave_xssp
      14                           .global _Ssave_xsp
      15                           .global _save_xssp
      16                           .global _first_save_xsp
      17                           .global _first_save_xssp
      18                           .global _first_flag
      19                           .global _save_xar7
      20                           .global _tZero
      21                           .global _save_xar6
      22                           .global _pxCurrentTCB                              ;; our currently exectuting TCB
      23                           .global _xTaskIncrementTick
      24                           .ref    _xTaskIncrementTick
      25                           .global _vTaskSwitchContext
      26                           .global _prvSetupTimerInterrupt
      27                           .global _tickIRQctr                                ;; debug - to be disabled during normal run/r
      28                           .global _save_new_pxcode                           ;; updated program counter that task suspende
      29                           .global _save_new_pxlcode                          ;; sysstack contents plus loop counter conten
      30                           .global _xCompareTCB                               ;; task Control Block for comparison
      31                                        .global _save_ac0
      32                                        .global _save_ac1
      33              ;                         .ref configUSE_TICK_CTR
      34              ;                         .ref configUSE_PREEMPTION
      35                                    .global _context_switch_counter
      36                           .def _vPortYield
      37                           .def _xPortStartScheduler
      38                           .def _vTickISR
      39                           .global _vPortYield
      40                           .global _xPortStartScheduler
      41                           .global _vTickISR
      42                           .global _INT14_ISR
      43                           .global _portFLAGS_INT_ENABLED
      44                           .global _portFLAGS_INT_ENABLED_POPPED
      45                           .global _DBSTAT_SAVE
      46                           .global _DBSTAT_RESTORE
      47                           .global _LOOP_BITS
      48                           .global _STATUS0_LOW
      49                           .global _STATUS0_HIGH
      50                           .global _STATUS1_LOW
      51                           .global _STATUS1_HIGH
      52                           .global _STATUS2_LOW
      53                           .global _STATUS2_HIGH
      54                           .global _PC_REG_HIGH_SAVE
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    2

      55                           .global _PC_REG_LOW_SAVE
      56                           .global _PC_REG_HIGH_RESTORE
      57                           .global _PC_REG_LOW_RESTORE
      58              ;            .cdecls C,NOLIST,"portmacro.h"
      59              ;            .cdecls C,LIST,"FreeRTOSConfig.h"
      60              ;                       CLRC AMODE
      61              ;       System Stack
      62 000000               .text
      63              portSAVE_CONTEXT .macro 
      64              ;                       ;CONTEXT_SAVE
      65              ;                       ASP  ; Align Stack Pointer
      66              ;                       CLRC       OVM,PAGE0
      67              ;                       CLRC       AMODE
      68              ;                       EALLOW
      69                              bclr C54CM      ; temp - until we figure out what is setting this
      70              ;;;             bset INTM               ; disable interrupts - already done
      71              ;                       aadd #1, sp
      72              ;                       mov xsp,  dbl (*(#_save_xsp))                   ; save xsp
      73              ;                       mov xssp, dbl (*(#_save_xssp))                  ; save xssp
      74              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
      75              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
      76              
      77              ;                       pshboth xar7
      78              ;                       pshboth xar6
      79              ;                       pshboth xar5
      80              
      81                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
      82              ;                       .if configUSE_CONTEXT_DEBUG == 1
      83                                      mov xar6, dbl (*(#_save_xar6))
      84              ;                       .endif
      85                                      aadd #1, sp
      86              ; +++===+++
      87              
      88                                      .if 0
      89                                      amov #0x000000, xar7
      90                                      amov #0x000000, xar6
      91                                      mov xsp, xar7
      92                                      mov xssp, xar6
      93                                      amov #0x000000, xar2
      94                                      amov #0x000000, xar1
      95                                      mov dbl (*(#_pxCurrentTCB)), xar5
      96              
      97                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
      98                                      mov dbl (*ar5(#2)), xar3
      99              
     100                                      mov *ar7, ar2                           ; current xsp contents
     101                                      mov *ar6, ar1                           ; current xssp contents
     102              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     103                                      mov ar2, *ar4
     104                                      mov ar1, *ar3
     105                                      .endif
     106              
     107                                      .if 1
     108              
     109                                      mov dbl (*(#_pxCurrentTCB)), xar7
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    3

     110                                      mov dbl (*ar5), xsp                             ; xsp contains our TCB now
     111                                      mov dbl (*ar5(#2)), xssp
     112                          amov #0x000000, xar7
     113                                      amov #0x000000, xar6
     114                          mov ar7, *(#_save_new_pxcode)
     115                          mov ssp, ar6
     116                          mov *ar6(#1), ar7                                                       ;; ssp+3
     117                          mov ar7, *(#_save_new_pxlcode)
     118                                      .endif
     119              
     120              ;                       mov ssp, ar7
     121              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
     122              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
     123              ;                       .endif
     124              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
     125              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
     126                                      .if 0
     127                                      amov #0x000000, xar7
     128                                      amov #0x000000, xar6
     129                          mov *sp(#0), ar7                                            ;; sp+3
     130                          mov ar7, *(#_save_new_pxcode)
     131                          mov ssp, ar6
     132                          mov *ar6(#1), ar7                                                       ;; ssp+3
     133                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
     134                                   ;   nop
     135                          mov dbl (*(#_pxCurrentTCB)), xar7
     136                          mov xar7, dbl(*(#_xCompareTCB))
     137                          .endif
     138              ; +++===+++
     139              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     140              ;
     141                                      mov dbl (*(#_pxCurrentTCB)), xar7
     142                                      mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
     143                                      mov dbl (*ar7(#2)), xssp
     144              ; +++===+++
     145                                      .if 0
     146              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
     147              ;                       mov xar7, ac0
     148              ;               mov xar6, ac1
     149              ;                       CMPU AC1 != AC0, TC1
     150              ;                               BCC $5,TC1
     151                                      amov #0x000000, xar7
     152                                          amov #0x000000, xar6
     153                                          mov  *(#_save_new_pxcode), ar7
     154                                          mov ar7, *sp(#0)
     155                              mov *(#_save_new_pxlcode) , ar7
     156                              mov ssp, ar6
     157                              mov ar7, *ar6(#0)
     158                              mov dbl (*(#_save_xar6)), xar6
     159                                         .endif
     160              ; +++===+++
     161              $5:
     162                                              
     163              ; +++===+++
     164              ;; what about xssp here?
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    4

     165              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
     166              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
     167                                 .if configUSE_CONTEXT_DEBUG == 1
     168              ;; save current PC (and possible loop bits values)
     169              ;; for debug - to see if this is being corrupted
     170                                      mov dbl(*ar7), xar6
     171                                      mov dbl(*ar6), xar7
     172                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
     173                                      mov xssp, xar7
     174                                      mov dbl(*ar7), xar6
     175                                      mov dbl(*ar6), xar7
     176                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
     177                                      mov xssp, xar7
     178                                      add #-2, ar7
     179                                      mov dbl(*ar7), xar6
     180                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
     181                          mov dbl (*(#_save_xar6)), xar6
     182              
     183              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
     184              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
     185              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
     186                                      .endif
     187              ; +++===+++
     188                                      ; save context in our stack(s) frame
     189              
     190              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
     191              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     192              ;;;                     mov dbl (*ar7(#2)), xssp
     193              ; +++===+++
     194              
     195                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     196                          mov dbl (*(#_save_xar6)), xar6
     197                                        ; restore xar6
     198              ;;; begin context save:
     199              
     200                                      mov xar7, dbl(*sp(#8))                          ; save xar7
     201                                      mov ar7, *sp(#7)
     202              
     203                                      mov xar6, dbl(*sp(#10))
     204                                      mov ar6, *sp(#9)
     205              
     206                                      mov xar5, dbl(*sp(#12))
     207                                      mov ar5, *sp(#11)
     208              
     209                                      mov xar4, dbl(*sp(#14))
     210                                      mov ar4, *sp(#13)
     211              
     212                                      mov xar3, dbl(*sp(#16))
     213                                      mov ar3, *sp(#15)
     214              
     215                                      mov xar2, dbl(*sp(#18))
     216                                      mov ar2, *sp(#17)
     217              
     218                                      mov xar1, dbl(*sp(#20))
     219                                      mov ar1, *sp(#19)
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    5

     220              
     221                                      mov xar0, dbl(*sp(#22))
     222                                      mov ar0, *sp(#21)
     223              
     224                          mov  ac0, dbl(*sp(#24))
     225                          mov ac0, *sp(#23)
     226              
     227                                      mov t3, *sp(#25)
     228                                      mov t2, *sp(#26)
     229                                      mov t1, *sp(#27)
     230                                      mov t0, *sp(#28)
     231              ; +++===+++
     232              ;;                      mov mmap(ST0_55), t0
     233              ; - this is ok - we are not pushing - it's a relative stack frame
     234              ;                       mov t0, *sp(#25)
     235              ;;                      mov t0, *sp(#23)
     236              ;;                      mov mmap(ST1_55), t1
     237              ;                       mov t1, *sp(#26)                ; stomping on own mem
     238              ;;                      mov t1, *sp(#21)                ; stomping on own mem
     239              ;;                      mov mmap(ST2_55), t2
     240              ;;                      mov t2, *sp(#22)
     241              ;                       mov t2, *sp(#27)
     242              ;;                      mov mmap(ST2_55), t3
     243              ;                       mov t3, *sp(#28)
     244              ;;                      mov t3, *sp(#24)
     245              
     246              ;                       PSH dbl(AR0) ; 32-bit
     247              ;                       PSH dbl(AR1) 
     248              ;                       PSH dbl(AR2) ; 32-bit
     249              ;                       PUSH XAR3 ; 32-bit
     250              ;                       PUSH XAR4 ; 32-bit
     251                              ;-- Comment these to save cycles --------
     252              ;                       PUSH XAR5 ; 32-bit
     253              ;                       PUSH XAR6 ; 32-bit
     254              ;                       PUSH XAR7 ; 32-bit
     255                              ;----------------------------------------
     256              
     257              ;                       PUSH XT   ; 32-bit
     258              
     259              ;                       movl xar6, @_portFLAGS_INT_ENABLED
     260              ;                       push xar6 ; portFLAGS_INT_ENABLED
     261              ; +++===+++
     262              
     263                                      mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
     264                                      mov xar6, dbl(*sp(#6))
     265                                      
     266              
     267              ;                       movl xar7, @_usCriticalNesting
     268              ;                       push xar7
     269                                      mov dbl (*(#_usCriticalNesting)), xar7
     270                                      mov xar7, dbl(*sp(#4))
     271              
     272                                      amov #0x000000, xar7
     273                                      amov #0x000000, xar6
     274              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    6

     275                                      mov mmap(ST1_55), ar7
     276                                      mov ar7, *sp(#1)
     277                                      mov  mmap(ST2_55), ar7
     278                                      mov ar7, *sp(#2)
     279              
     280                                      mov ssp, ar7
     281              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
     282              ;                       and #0xFF00, ar6
     283              ;                       mov ar6, *ar7(#1)
     284              
     285                                      mov mmap(ST0_55), ar6
     286                                      mov ar6, *ar7(#2)
     287                                      
     288                                      mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
     289                                      mov ar6, *ar7(#1)
     290              ; +++===+++
     291              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
     292              ;                       mov dbl (*(#_save_xssp)), xssp          
     293              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
     294              ;;;                     mov ar6, *ar7(#2)
     295              ;                       mov ar7, mmap(ST0_55)
     296              ;                       mov *ssp(#2), ar7
     297              ; fix up
     298              ;                       aadd #20, sp
     299              ;                       mov sp, t0
     300              ;                       sub #1, t0
     301              ;                       mov t0, ssp
     302              
     303                                      ; move contents of SP into address of current TCB
     304              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
     305              
     306              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     307              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     308              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     309              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     310              ;                       mov dbl (*ar7+), xssp
     311              
     312              ;                       mov sp, t0              ; we've already saved t0
     313              ;                       add #1, t0
     314              ;                       mov t0, ssp
     315              ; ??
     316              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
     317              
     318              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
     319              ;                       mov al, @sp
     320              ;                       movl  *xar6, acc        
     321              ;;                      mov  ar0, @sp
     322              ;;                      mov  @ar6, alxd
     323              ;;                      mov  ar0, @sp
     324              ;;                      movl 0(xar6), sp
     325              ;                       EDIS
     326              ;                       NASP
     327              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
     328              ;                       NOP
     329                                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    7

     330                                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp
     331                                      nop
     332              ;                       aadd #-1, sp
     333                                      nop
     334              
     335                                      nop
     336                                                                                      ; ?
     337                                      .endm
     338              
     339              portRESTORE_CONTEXT .macro
     340                                      .C54CM_off
     341              ;                       .CPL_off
     342                                      .ARMS_off
     343                                      .align 4
     344              
     345              ; Restore context & return
     346                                      ;CONTEXT_RESTORE
     347              ;                       ASP
     348              ;                       EALLOW
     349              ;                       nop
     350              ;                       nop
     351              ;                       nop
     352              ;                       nop
     353                              bclr C54CM
     354              ;               xssp = dbl(*(#_pxCurrentTCB))
     355              ;               xsp  = dbl(*(#_pxCurrentTCB))
     356                                      mov xar7, dbl (*(#_save_xar7))  
     357                                      mov xar6, dbl (*(#_save_xar6))
     358              
     359                                      aadd #-1, sp
     360              ;            aadd #-3, xsp
     361              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     362              ;            BCC $1,TC1 ; |216|
     363                                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     364                                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     365              ;            B $4
     366              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
     367              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
     368              
     369              ;;                      aadd #1, sp
     370              ;$1
     371              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     372              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
     373              ;$4
     374                                      .if 1
     375                                      mov xsp, xar7
     376                                      mov xssp, xar6
     377                                      amov #0x000000, xar2
     378                                      amov #0x000000, xar1
     379                                      mov dbl (*(#_pxCurrentTCB)), xar5                       
     380              
     381                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
     382                                      mov dbl (*ar5(#2)), xar3                        
     383                                      
     384                                      mov *ar4, ar2
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    8

     385                                      mov *ar3, ar1
     386              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     387                                      mov ar2, *ar7
     388                                      mov ar1, *ar6
     389              
     390                                      mov mmap(ST1_55), ar7
     391                                      and #0xf7ff, ar7                        ; <here>#0800h
     392                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     393                                      mov ar7, *ar4(#1)                       ; save in TCB
     394                                      mov mmap(ST2_55), ar7
     395                                      mov ar7, *sp(#2)
     396                                      mov ar7, *ar4(#2)
     397              
     398                                      mov ssp, ar7
     399                                      mov mmap(ST0_55), ar6
     400                                      mov ar6, *ar7(#2)
     401                                      mov ar6, *ar3(#2)
     402                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     403                                      mov ar6, *ar7(#1)
     404                                      mov ar6, *ar3(#1)
     405                                      .endif
     406              
     407              ;                       mov #0, ssp     
     408              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     409              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     410                                      ; 32-bit mode - will act on SP and SSP:
     411              ;                       'fix-up' current SP and SSP - is this dangerous????
     412              ;                       aadd #-3, sp
     413              ;;                      mov *ar7, *sp
     414              ;                       mov dbl (*ar7), ar6
     415              ;                       mov ar6, *sp                            ; xsp contains our TCB now
     416              ;                       mov *ar7(#2), *ssp                      
     417              ;                       POP mmap(ST3_55)
     418              ;                       pshboth xar7                            ; should increment both
     419                                      .if 0
     420                                      mov mmap(ST1_55), ar7
     421                                      and #0xf7ff, ar7                        ; <here>#0800h
     422                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     423                                      mov mmap(ST2_55), ar7
     424                                      mov ar7, *sp(#2)
     425              
     426                                      mov ssp, ar7
     427                                      mov mmap(ST0_55), ar6
     428                                      mov ar6, *ar7(#2)
     429              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
     430              ;;                      mov ar6, *ar7(#1)
     431                                      .endif
     432              ; +++===+++
     433                                      .if 0
     434                                      mov dbl (*(#_pxCurrentTCB)), xar7
     435                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     436                                      mov dbl (*ar7(#2)), xssp        
     437                                      .endif
     438              ; +++===+++
     439                                      .if 0
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE    9

     440                                      mov dbl (*(_xCompareTCB)), xar6
     441              ; need to restore our return address
     442                                      mov xar7, ac0
     443                                          mov xar6, ac1
     444                                          CMPU AC1 != AC0, TC1 ; |1393|
     445                                          BCC $6,TC1 ; |1393|
     446                                          amov #0x000000, xar7
     447                                          amov #0x000000, xar6
     448                                          mov  *(#_save_new_pxcode), ar7
     449                                          mov ar7, *sp(#0)
     450                                          mov *(#_save_new_pxlcode) , ar7
     451                                          mov ssp, ar6
     452                                          mov ar7, *ar6(#0)
     453              
     454                                          mov dbl (*(#_save_xar6)), xar6
     455                                                              .endif
     456              ; +++===+++
     457              $6:
     458              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
     459              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
     460                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
     461                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
     462                                      mov xar6, dbl (*(#_save_xar6))
     463              
     464              ;; this is for debug
     465                                      mov dbl(*ar7), xar6
     466                                      mov dbl(*ar6), xar7
     467                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
     468                                      mov xssp, xar7
     469                                      mov dbl(*ar7), xar6
     470                                      mov dbl(*ar6), xar7
     471                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
     472                                      mov xssp, xar7
     473                                      add #-2, ar7
     474                                      mov dbl(*ar7), xar6
     475                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
     476                                      mov dbl (*(#_save_xar6)), xar6
     477                                      
     478                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     479                                      .endif
     480              ; +++===+++
     481              ;                       mov mmap(ST0_55), *ssp(#1)
     482              ;                       mov mmap(STO_55), *ssp(#2)
     483              ;                       mov mmap(ST1_55), *sp(#1)
     484              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
     485              ;                       mov *ar7, t0
     486              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
     487              ;                       mov *ar7(#2), t0
     488              ;                       mov t0, *ssp(#0)                        
     489              
     490              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
     491              ; what about xssp?
     492              ;                       mov xar6, xsp
     493              ;                       mov xssp, xar7
     494              ;                       add #1, ar7
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   10

     495              ;                       mov xar7, xsp
     496              ;                       mov sp, t0
     497              ;                       mov ssp, t1
     498              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
     499              ;                       ar0 = *ar6
     500              ;                       xssp = xar0
     501              ;                       mov *xar6, xar0
     502              ;                       mov xar0, xssp  ; stack now points to our TCB
     503              ;;                      mov sp, *ar6
     504              ;;                      mov sp, ar0
     505              ;;                      mov sp, *_pxCurrentTCB
     506              ;;                      clr ar0
     507              ;;                      mov ar0, @xar6
     508              ;;                      mov sp, AR0
     509              ;;                      add sp, xar6
     510              
     511              ;;                      pshboth xar7
     512              ;;                      pshboth xar6
     513              ;;                      pshboth xar5
     514              
     515              ;;                      popboth xar5
     516              ;;                      popboth xar6
     517              ;;                      popboth xar7
     518              
     519              ;;;                     mov *sp(#1), ar7 
     520              ;                       mov dbl(*sp(#1)), ar7
     521              ;;;                     mov  ar7, mmap(ST1_55)
     522              ; +++===+++
     523                                      mov dbl (*(#_pxCurrentTCB)), xar7
     524                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     525                                      mov dbl (*ar7(#2)), xssp
     526              ; +++===+++
     527                                      .if 0
     528                                      mov *sp(#2), ar7
     529                                      mov ar7, mmap(ST2_55)
     530                                      mov ssp, ar7
     531                                      mov *ar7(#2), ar6
     532                                      mov ar6, mmap(ST0_55)
     533                                      .endif
     534              ;                       mov *ar7(#2), ar6
     535              ;                       mov ar6, *ssp(#2)
     536              ;                       mov *ssp(#2), ar7
     537              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
     538              ;
     539              ; restore context
     540              
     541                                      amov #0x000000, xar2
     542                                      amov #0x000000, xar1
     543              
     544                                      mov mmap(ST1_55), ar7
     545                                      and #0xf7ff, ar7                        ; <here>#0800h
     546                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     547                                      mov ar7, mmap(ST1_55)
     548              ;                       mov ar7, *ar4(#1)                       ; save in TCB
     549                                      mov mmap(ST2_55), ar7
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   11

     550                                      mov ar7, *sp(#2)
     551              ;                       mov ar7, *ar4(#2)
     552              
     553                                      mov ssp, ar7
     554                                      mov mmap(ST0_55), ar6
     555                                      mov ar6, *ar7(#2)
     556              ;                       mov ar6, *ar3(#2)
     557                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     558                                      mov ar6, *ar7(#1)
     559              ;                       mov ar6, *ar3(#2)
     560              
     561              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
     562              ;;                      and #0xFF00, ar6
     563              ;;                      mov ar6, *ar7(#1)
     564              
     565                                      mov dbl(*sp(#4)), xar7
     566              ;                       mov *sp(#1), ar7
     567                                      mov xar7, dbl(*(#_usCriticalNesting))   
     568              
     569                                      mov dbl(*sp(#6)), xar6
     570              ;                       mov *sp(#3), ar6
     571              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
     572                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
     573              ;                       POP XT
     574                              ;-- Comment these to save cycles ---
     575                                      mov dbl(*sp(#8)), xar7
     576                                      mov *sp(#7), ar7
     577              ;                       mov *sp(#5), ar7
     578              ;                       mov dbl(*sp(#0)), hi(ar7)
     579              ;                       mov (*sp(#0)), lo(ar7)
     580                                      mov dbl(*sp(#10)), xar6
     581                                      mov *sp(#9), ar6
     582                                      mov dbl(*sp(#12)), xar5
     583                                      mov *sp(#11), ar5
     584              ;; pvPararmeters currently here - needs to be verified --- jcw
     585                                      mov dbl(*sp(#14)), xar4
     586                                      mov *sp(#13), ar4
     587                                      mov dbl(*sp(#16)), xar3
     588                                      mov *sp(#15), ar3
     589                                      mov dbl(*sp(#18)), xar2
     590                                      mov *sp(#17), ar2
     591                                      mov dbl(*sp(#20)), xar1
     592                                      mov *sp(#19), ar1
     593                                      mov dbl(*sp(#22)), xar0
     594                                      mov *sp(#21), ar0
     595                                  mov dbl(*sp(#24)), ac0
     596                          mov *sp(#23), ac0
     597              
     598                                      mov *sp(#25), t3
     599                                      mov *sp(#26), t2
     600                                      mov *sp(#27), t1
     601                                      mov *sp(#28), t0
     602              
     603              ;                       mov dbl(*sp(#21)), *xssp(#0)
     604              ;                       mov *sp(#21), *ssp
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   12

     605              ;                       mov *sp(#21), RETA
     606              ; need to move 23-16 to XSSP contents
     607              ;                       mov xar0, dbl (*(#_save_xar7))
     608              ;                       mov ssp, ar0
     609              ;                       mov #0, ssp 
     610              ;                       mov xssp, xar0
     611              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
     612              ;                       aadd #20, sp            ; this is ok - ssp also incremented
     613                      ;               add #1, xssp            ; 32-bit return address pointer
     614                      ;               amar *xssp+
     615              ;                       mov sp, t0
     616              ;                       add #1, t0
     617              ;                       mov t0, ssp
     618              ;                       incr ssp
     619              ;                       asub #20, ar0
     620              ;                       mov xar0, xssp
     621              ;                       mov ar0, ssp
     622              ;                       mov ar0, 
     623              ;;                      mov *sp(#1), t0
     624              ;;                      mov *sp(#3), t3         ; ST0
     625              ;;                      mov *sp(#4), t2         ; DBSTAT
     626              ;;                      mov t3, *ar0(#2)
     627                      ;;              mov t2, *ar0(#1)
     628              ;;                      mov t0, *ar0(#0)
     629              
     630              ;;                      mov *sp(#5), t0
     631              ;;                      mov *sp(#6), t1
     632              ;;                      mov *sp(#7), t2
     633                      ;;              mov *sp(#8), t3
     634              
     635              ; restore ar0
     636              ;                       mov dbl(*sp(#-2)), xar0
     637              ;                       mov #-1, ar0
     638              ;;                      mov dbl (*(#_save_xar7)), xar0
     639              ;;
     640              ;;                      mov sp, t0
     641              ;;                      add #1, t0
     642              ;;                      mov t0, ssp
     643              
     644              ;                       mov *sp(#3), *(#00004ch+#1)
     645              
     646              ;                       mov t3, *ssp(#1) 
     647              ;                       mov t2, *ssp(#2)
     648              
     649              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
     650              ;;                      mov t3, *(ssp(#0))
     651              ;                       mov t3, *ssp
     652              ;                       mov *sp(#3), t3 ; 
     653              ;                       mov t3, *ssp(#1)
     654              ;;                      mov *sp(#21), PC        
     655              
     656              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
     657              ;                       mov dbl(xsp), dbl(lcrpc)
     658              ;                       popboth XAR7
     659              ;                       add #1, sp
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   13

     660              ;                       add #1, ssp
     661              ;                       add #2, t0
     662              ;                       add #2, t1
     663              ;                       mov t0, sp
     664              ;                       mov t1, ssp
     665              ;                       popboth XAR6
     666              ;                       add #2, t0
     667              ;                       add #2, t1
     668              ;                       mov t0, sp
     669              ;                       mov t1, ssp
     670              ;                       popboth XAR5
     671              ;                       add #2, t0
     672              ;                       add #2, t1
     673              ;                       mov t0, sp
     674              ;                       mov t1, ssp
     675                              ;-----------------------------------
     676              ;                       popboth XAR4
     677              ;                       add #2, t0
     678              ;                       add #2, t1
     679              ;                       mov t0, sp
     680              ;                       mov t1, ssp
     681              ;                       popboth XAR3
     682              ;                       add #2, t0
     683              ;                       add #2, t1
     684              ;                       mov t0, sp
     685              ;                       mov t1, ssp
     686              ;                       popboth XAR2
     687              ;                       add #2, t0
     688              ;                       add #2, t1
     689              ;                       mov t0, sp
     690              ;                       mov t1, ssp
     691              ;                       popboth XAR1
     692              ;                       add #2, t0
     693              ;                       add #2, t1
     694              ;                       mov t0, sp
     695              ;                       mov t1, ssp
     696              ;                       popboth XAR0
     697              ;                       add #2, t0
     698              ;                       add #2, t1
     699              ;                       mov t0, sp
     700              ;                       mov t1, ssp
     701              ;                       EDIS
     702              ;                       NASP    ; Un-align stack pointer
     703              ;;                      pop mmap(ST3_55)
     704              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     705              ;            BCC $2,TC1 ; |216|
     706                                      .if 0
     707                                      mov dbl (*(#_pxCurrentTCB)), xar7
     708              
     709                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     710                                      mov dbl (*ar7(#2)), xssp                
     711                                      .endif
     712              
     713                                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     714                              mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   14

     715              
     716                                      .if 0
     717                                      mov dbl (*(_xCompareTCB)), xar6
     718              ; need to restore our return address
     719                                      mov xar7, ac0
     720                          mov xar6, ac1
     721                              CMPU AC1 != AC0, TC1 ; |1393|
     722                          BCC $6,TC1 ; |1393|
     723                          amov #0x000000, xar7
     724                                      amov #0x000000, xar6
     725                          mov  *(#_save_new_pxcode), ar7
     726                                      mov ar7, *sp(#0)
     727                          mov *(#_save_new_pxlcode) , ar7
     728                          mov ssp, ar6
     729                          mov ar7, *ar6(#0)
     730              
     731                          mov dbl (*(#_save_xar6)), xar6
     732                                      .endif
     733              
     734                                      mov dbl (*(#_save_xar7)), xar7
     735              
     736              ;                       B $3
     737              ;$2
     738              ;           MOV #0, *(#_first_flag) ; |217|
     739              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     740              ;                       mov dbl (*(#_first_save_xssp)), xssp
     741              ;$3
     742              ;;                      aadd #1, sp
     743                                      bclr INTM               ; enable interrupts
     744              ;                       aadd #1, sp
     745                                      RETI
     746              ;                       mov #1860h, ssp
     747                                      nop
     748                                      nop
     749              ;                       nop
     750                                      .endm
     751              
     752              
     753              portRESTORE_FIRST_CONTEXT .macro
     754                                      .C54CM_off
     755              ;                       .CPL_off
     756                                      .ARMS_off
     757                                      .align 4
     758              
     759              ; Restore context & return
     760                                      ;CONTEXT_RESTORE
     761              ;                       ASP
     762              ;                       EALLOW
     763              ;                       nop
     764              ;                       nop
     765              ;                       nop
     766              ;                       nop
     767                              bclr C54CM
     768              ;               xssp = dbl(*(#_pxCurrentTCB))
     769              ;               xsp  = dbl(*(#_pxCurrentTCB))
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   15

     770                                      mov xar7, dbl (*(#_save_xar7))  
     771              
     772              ; ****************************************************************************
     773              ; * Init Stack Pointer. Remember stack grows from high to low address *
     774              ; ****************************************************************************
     775              ;                       stm #_stack, sp ; set to begging of stack memory
     776              ;                       addm #(_STACK_SIZE  1), *(SP) ; add size to get to the top
     777              ;                       andm #0FFFEh, *(SP) ; make sure it is an even address
     778              
     779              ;                       aadd #-1, sp
     780              ;            aadd #-3, xsp
     781              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
     782              ;            BCC $1,TC1 ; |216|
     783                                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
     784                                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
     785              ;            B $4
     786              
     787              ;                       mov xsp, dbl (*(#_save_xsp))                    ; save xsp
     788              ;                       mov xssp, dbl (*(#_save_xssp))                  ; save xssp
     789              
     790              ;;;                     aadd #-1, sp
     791              ;$1
     792              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
     793              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
     794              ;$4
     795                                      .if 1
     796                                      mov xsp, xar7
     797                                      mov xssp, xar6
     798                                      amov #0x000000, xar2
     799                                      amov #0x000000, xar1
     800                                      amov #0x000000, xar3
     801                                      amov #0x000000, xar4
     802              
     803                                      mov dbl (*(#_pxCurrentTCB)), xar5                               
     804              
     805                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
     806                                      mov dbl (*ar5(#2)), xar3                        ; xssp          
     807                                      
     808                                      mov *ar4, ar2
     809                                      mov *ar3, ar1
     810              ;                       mov ar4, *ar6                           ; stack pointers fixed up
     811                                      mov ar2, *ar7
     812                                      mov ar1, *ar6   
     813                                      .endif
     814              
     815              ;
     816              ;                       amov #0x000000, xar7
     817              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     818              
     819              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     820              ;                       mov dbl (*ar7(#2)), xssp
     821                                      .if 1
     822                          amov #0x000000, xar7
     823                                  mov mmap(ST1_55), ar7
     824                                      and #0xf7ff, ar7                        ; <here>#0800h
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   16

     825                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     826                                      mov ar7, *ar4(#1)                       ; save in TCB
     827                                      mov mmap(ST2_55), ar7
     828                                      mov ar7, *sp(#2)
     829                                      mov ar7, *ar4(#2)
     830                          amov #0x000000, xar6
     831                                      amov #0x000000, xar7
     832              
     833                                      mov ssp, ar7
     834                                      mov mmap(ST0_55), ar6
     835                                      mov ar6, *ar7(#2)
     836                                      mov ar6, *ar3(#2)
     837                                      
     838                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     839                                      mov ar6, *ar7(#1)
     840                                      mov ar6, *ar3(#1)
     841              
     842                                      .endif
     843              
     844              ;                       mov #0, ssp     
     845              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
     846              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
     847                                      ; 32-bit mode - will act on SP and SSP:
     848              ;                       'fix-up' current SP and SSP - is this dangerous????
     849              ;                       aadd #-3, sp
     850              ;;                      mov *ar7, *sp
     851              ;                       mov dbl (*ar7), ar6
     852              ;                       mov ar6, *sp                            ; xsp contains our TCB now
     853              ;                       mov *ar7(#2), *ssp                      
     854              ;                       POP mmap(ST3_55)
     855              ;                       pshboth xar7                            ; should increment both
     856                                      .if 0
     857                                      mov mmap(ST1_55), ar7
     858                                      and #0xf7ff, ar7                        ; <here>#0800h
     859                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     860                                      mov mmap(ST2_55), ar7
     861                                      mov ar7, *sp(#2)
     862              
     863                                      mov ssp, ar7
     864                                      mov mmap(ST0_55), ar6
     865                                      mov ar6, *ar7(#2)
     866                                      .endif
     867              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
     868              ;;                      mov ar6, *ar7(#1)
     869              
     870                                      .if 0
     871                                      mov dbl (*(#_pxCurrentTCB)), xar7
     872              
     873                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     874                                      mov dbl (*ar7(#2)), xssp        
     875                                      .endif
     876              
     877                                      .if 0                                           ; first task - no pxcode update
     878                                          mov dbl (*(_xCompareTCB)), xar6
     879              ; need to restore our return address
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   17

     880                                          mov xar7, ac0
     881                                          mov xar6, ac1
     882                                          CMPU AC1 != AC0, TC1 ; |1393|
     883                                          BCC $7,TC1 ; |1393|
     884                                          amov #0x000000, xar7
     885                                          amov #0x000000, xar6
     886                                          mov  *(#_save_new_pxcode), ar7
     887                                          mov ar7, *sp(#0)
     888                                          mov *(#_save_new_pxlcode) , ar7
     889                                          mov ssp, ar6
     890                                          mov ar7, *ar6(#0)
     891              
     892                                          mov dbl (*(#_save_xar6)), xar6
     893                                          .endif
     894              $7:
     895              
     896              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
     897              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
     898                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
     899                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
     900                                      mov xar6, dbl (*(#_save_xar6))
     901              
     902              ;; this is for debug
     903                                      mov dbl(*ar7), xar6
     904                                      mov dbl(*ar6), xar7
     905                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
     906                                      mov xssp, xar7
     907                                      mov dbl(*ar7), xar6
     908                                      mov dbl(*ar6), xar7
     909                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
     910                                      mov xssp, xar7
     911                                      add #-2, ar7
     912                                      mov dbl(*ar7), xar6
     913                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
     914                                      mov dbl (*(#_save_xar6)), xar6
     915                                      
     916                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
     917                                      .endif
     918              
     919              ;                       mov mmap(ST0_55), *ssp(#1)
     920              ;                       mov mmap(STO_55), *ssp(#2)
     921              ;                       mov mmap(ST1_55), *sp(#1)
     922              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
     923              ;                       mov *ar7, t0
     924              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
     925              ;                       mov *ar7(#2), t0
     926              ;                       mov t0, *ssp(#0)                        
     927              
     928              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
     929              ; what about xssp?
     930              ;                       mov xar6, xsp
     931              ;                       mov xssp, xar7
     932              ;                       add #1, ar7
     933              ;                       mov xar7, xsp
     934              ;                       mov sp, t0
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   18

     935              ;                       mov ssp, t1
     936              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
     937              ;                       ar0 = *ar6
     938              ;                       xssp = xar0
     939              ;                       mov *xar6, xar0
     940              ;                       mov xar0, xssp  ; stack now points to our TCB
     941              ;;                      mov sp, *ar6
     942              ;;                      mov sp, ar0
     943              ;;                      mov sp, *_pxCurrentTCB
     944              ;;                      clr ar0
     945              ;;                      mov ar0, @xar6
     946              ;;                      mov sp, AR0
     947              ;;                      add sp, xar6
     948              
     949              ;;                      pshboth xar7
     950              ;;                      pshboth xar6
     951              ;;                      pshboth xar5
     952              
     953              ;;                      popboth xar5
     954              ;;                      popboth xar6
     955              ;;                      popboth xar7
     956              
     957              ;;;                     mov *sp(#1), ar7 
     958              ;                       mov dbl(*sp(#1)), ar7
     959              ;;;                     mov  ar7, mmap(ST1_55)
     960              
     961                                      amov #0x000000, xar7
     962                                  mov dbl (*(#_pxCurrentTCB)), xar7
     963                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
     964                                      mov dbl (*ar7(#2)), xssp        
     965              
     966                                      .if 0
     967                                      mov *sp(#2), ar7
     968                                      mov ar7, mmap(ST2_55)
     969                                      mov ssp, ar7
     970                                      mov *ar7(#2), ar6
     971                                      mov ar6, mmap(ST0_55)
     972                                      .endif
     973              ;                       mov *ar7(#2), ar6
     974              ;                       mov ar6, *ssp(#2)
     975              ;                       mov *ssp(#2), ar7
     976              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
     977              
     978                          amov #0x000000, xar7
     979                                      amov #0x000000, xar6
     980                                      .if 0
     981                                      mov mmap(ST1_55), ar7
     982                                      and #0xf7ff, ar7                        ; <here>#0800h
     983                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
     984              ;                       mov ar7, *ar4(#1)                       ; save in TCB
     985                          amov #0x000000, xar7
     986                                      mov mmap(ST2_55), ar7
     987                                      mov ar7, *sp(#2)
     988              ;                       mov ar7, *ar4(#2)
     989                          amov #0x000000, xar7
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   19

     990                          amov #0x000000, xar6
     991                                      mov ssp, ar7
     992                                      mov mmap(ST0_55), ar6
     993                                      mov ar6, *ar7(#2)
     994              ;                       mov ar6, *ar3(#2)
     995                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
     996                                      mov ar6, *ar7(#1)
     997              ;                       mov ar6, *ar3(#2)
     998                                      .endif
     999              ;                       mov *(#_LOOP_BITS), ar6         ; have to restore this
    1000              ;                       and #0xFF00, ar6
    1001              ;                       mov ar6, *ar7(#2)
    1002              
    1003                          amov #0x000000, xar7
    1004                                      mov dbl(*sp(#4)), xar7
    1005              ;                       mov *sp(#1), ar7
    1006                                      mov xar7, dbl(*(#_usCriticalNesting))   
    1007                          amov #0x000000, xar6
    1008                                      mov dbl(*sp(#6)), xar6
    1009              ;                       mov *sp(#3), ar6
    1010              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1011                                      mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
    1012              
    1013              ;                       POP XT
    1014                              ;-- Comment these to save cycles ---
    1015                                      mov dbl(*sp(#8)), xar7
    1016                                      mov *sp(#7), ar7
    1017              ;                       mov *sp(#5), ar7
    1018              ;                       mov dbl(*sp(#0)), hi(ar7)
    1019              ;                       mov (*sp(#0)), lo(ar7)
    1020                                      mov dbl(*sp(#10)), xar6
    1021                                      mov *sp(#9), ar6
    1022                                      mov dbl(*sp(#12)), xar5
    1023                                      mov *sp(#11), ar5
    1024              ;; pvPararmeters currently here - needs to be verified --- jcw
    1025                                      mov dbl(*sp(#14)), xar4
    1026                                      mov *sp(#13), ar4
    1027                                      mov dbl(*sp(#16)), xar3
    1028                                      mov *sp(#15), ar3
    1029                                      mov dbl(*sp(#18)), xar2
    1030                                      mov *sp(#17), ar2
    1031                                      mov dbl(*sp(#20)), xar1
    1032                                      mov *sp(#19), ar1
    1033                                      mov dbl(*sp(#22)), xar0
    1034                                      mov *sp(#21), ar0
    1035                          mov dbl(*sp(#24)), ac0
    1036                          mov *sp(#23), ac0
    1037              
    1038                                      mov *sp(#25), t3
    1039                                      mov *sp(#26), t2
    1040                                      mov *sp(#27), t1
    1041                                      mov *sp(#28), t0
    1042              
    1043              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1044              ;                       mov *sp(#21), *ssp
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   20

    1045              ;                       mov *sp(#21), RETA
    1046              ; need to move 23-16 to XSSP contents
    1047              ;                       mov xar0, dbl (*(#_save_xar7))
    1048              ;                       mov ssp, ar0
    1049              ;                       mov #0, ssp 
    1050              ;                       mov xssp, xar0
    1051              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1052              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1053                      ;               add #1, xssp            ; 32-bit return address pointer
    1054                      ;               amar *xssp+
    1055              ;                       mov sp, t0
    1056              ;                       add #1, t0
    1057              ;                       mov t0, ssp
    1058              ;                       incr ssp
    1059              ;                       asub #20, ar0
    1060              ;                       mov xar0, xssp
    1061              ;                       mov ar0, ssp
    1062              ;                       mov ar0, 
    1063              ;;                      mov *sp(#1), t0
    1064              ;;                      mov *sp(#3), t3         ; ST0
    1065              ;;                      mov *sp(#4), t2         ; DBSTAT
    1066              ;;                      mov t3, *ar0(#2)
    1067                      ;;              mov t2, *ar0(#1)
    1068              ;;                      mov t0, *ar0(#0)
    1069              
    1070              ;;                      mov *sp(#5), t0
    1071              ;;                      mov *sp(#6), t1
    1072              ;;                      mov *sp(#7), t2
    1073                      ;;              mov *sp(#8), t3
    1074              
    1075              ; restore ar0
    1076              ;                       mov dbl(*sp(#-2)), xar0
    1077              ;                       mov #-1, ar0
    1078              ;;                      mov dbl (*(#_save_xar7)), xar0
    1079              ;;
    1080              ;;                      mov sp, t0
    1081              ;;                      add #1, t0
    1082              ;;                      mov t0, ssp
    1083              
    1084              ;                       mov *sp(#3), *(#00004ch+#1)
    1085              
    1086              ;                       mov t3, *ssp(#1) 
    1087              ;                       mov t2, *ssp(#2)
    1088              
    1089              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1090              ;;                      mov t3, *(ssp(#0))
    1091              ;                       mov t3, *ssp
    1092              ;                       mov *sp(#3), t3 ; 
    1093              ;                       mov t3, *ssp(#1)
    1094              ;;                      mov *sp(#21), PC        
    1095              
    1096              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1097              ;                       mov dbl(xsp), dbl(lcrpc)
    1098              ;                       popboth XAR7
    1099              ;                       add #1, sp
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   21

    1100              ;                       add #1, ssp
    1101              ;                       add #2, t0
    1102              ;                       add #2, t1
    1103              ;                       mov t0, sp
    1104              ;                       mov t1, ssp
    1105              ;                       popboth XAR6
    1106              ;                       add #2, t0
    1107              ;                       add #2, t1
    1108              ;                       mov t0, sp
    1109              ;                       mov t1, ssp
    1110              ;                       popboth XAR5
    1111              ;                       add #2, t0
    1112              ;                       add #2, t1
    1113              ;                       mov t0, sp
    1114              ;                       mov t1, ssp
    1115                              ;-----------------------------------
    1116              ;                       popboth XAR4
    1117              ;                       add #2, t0
    1118              ;                       add #2, t1
    1119              ;                       mov t0, sp
    1120              ;                       mov t1, ssp
    1121              ;                       popboth XAR3
    1122              ;                       add #2, t0
    1123              ;                       add #2, t1
    1124              ;                       mov t0, sp
    1125              ;                       mov t1, ssp
    1126              ;                       popboth XAR2
    1127              ;                       add #2, t0
    1128              ;                       add #2, t1
    1129              ;                       mov t0, sp
    1130              ;                       mov t1, ssp
    1131              ;                       popboth XAR1
    1132              ;                       add #2, t0
    1133              ;                       add #2, t1
    1134              ;                       mov t0, sp
    1135              ;                       mov t1, ssp
    1136              ;                       popboth XAR0
    1137              ;                       add #2, t0
    1138              ;                       add #2, t1
    1139              ;                       mov t0, sp
    1140              ;                       mov t1, ssp
    1141              ;                       EDIS
    1142              ;                       NASP    ; Un-align stack pointer
    1143              ;;                      pop mmap(ST3_55)
    1144              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1145              ;            BCC $2,TC1 ; |216|
    1146                                      .if 0
    1147                                      amov #0x000000, xar7
    1148                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1149              
    1150                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1151                                      mov dbl (*ar7(#2)), xssp                
    1152                                      .endif
    1153              
    1154                                      mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   22

    1155                                      mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1156              
    1157                                      .if 0
    1158                                      mov dbl (*(_xCompareTCB)), xar6
    1159              ; need to restore our return address
    1160                                      mov xar7, ac0
    1161                          mov xar6, ac1
    1162                              CMPU AC1 != AC0, TC1 ; |1393|
    1163                          BCC $6,TC1 ; |1393|
    1164                          amov #0x000000, xar7
    1165                                      amov #0x000000, xar6
    1166                          mov  *(#_save_new_pxcode), ar7
    1167                                      mov ar7, *sp(#0)
    1168                          mov *(#_save_new_pxlcode) , ar7
    1169                          mov ssp, ar6
    1170                          mov ar7, *ar6(#0)
    1171              
    1172                          mov dbl (*(#_save_xar6)), xar6
    1173                                      .endif
    1174              
    1175                                      mov dbl (*(#_save_xar7)), xar7
    1176              
    1177              ;                       B $3
    1178              ;$2
    1179              ;            MOV #0, *(#_first_flag) ; |217|
    1180              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1181              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1182              ;$3
    1183              ;                       aadd #-3, sp
    1184              ;                       aadd #1, sp
    1185                                      bclr INTM               ; enable interrupts
    1186              ;                       aadd #1, sp
    1187                                      RETI
    1188              ;                       mov #1860h, ssp
    1189                                      nop
    1190                                      nop
    1191              ;                       nop
    1192                                      .endm
    1193              ; /*-----------------------------------------------------------*/
    1194              
    1195              
    1196              
    1197              ; /*-----------------------------------------------------------*/
    1198              
    1199              ; /*
    1200              ; * The RTOS tick ISR.
    1201              ; *
    1202              ; * If the cooperative scheduler is in use this simply increments the tick
    1203              ; * count.
    1204              ; *
    1205              ; * If the preemptive scheduler is in use a context switch can also occur.
    1206              ; */
    1207              
    1208              
    1209 000000       _xPortStartScheduler:
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   23

    1210              
    1211              ;                /* Setup the hardware to generate the tick.  Interrupts are disabled
    1212              ;                when this function is called. */
    1213 000000 4EFF                 aadd #-1, sp
    1214 000002 6C00                 call    #_prvSetupTimerInterrupt
         000004 0000!
    1215              
    1216              ;                /* Restore the context of the first task that is going to run. */
    1217              
    1218              ;;              INTR INT14      ; force interrupt - just for debug purposes.
    1219              
    1220              ;;            psh mmap(ST3_55)
    1221 000006 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         000008 F500 
         00000a 0000!
    1222 00000c EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save xar6
         00000e E500 
         000010 0000!
    1223              
    1224 000012 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         000014 FF00 
         000016 0000!
    1225              ; does this *always* work?
    1226 000018 EDE1                          mov dbl (*ar7), xar6
         00001a EF   
    1227              ;                       mov xsp, dbl (*(#_first_save_xsp))      ; (init) xsp contains our TCB now
    1228 00001b EB31                          mov xsp, dbl (*(#_save_xsp))            ; (init) xsp contains our TCB now
         00001d 4500 
         00001f 0000!
    1229              ;                       mov xar6, dbl (*(#_save_xsp))   
    1230 000021 EDE3                          mov dbl (*ar7+), xar6
         000023 EF   
    1231              ;                       mov xssp, dbl (*(#_first_save_xssp))
    1232 000024 EB31                          mov xssp, dbl (*(#_save_xssp))
         000026 5500 
         000028 0000!
    1233              ;                       mov #1, *(#_first_flag)
    1234                                      .if 0
    1235                                      amov #0x000000, xar7
    1236                                      amov #0x000000, xar6
    1237                                      mov ssp, ar7
    1238                                      mov *ar7(#2), ar6                               ; this is two away now
    1239                                      mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1240                                      .endif
    1241              ; what about xssp here?
    1242 00002a ED31                          mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         00002c FF00 
         00002e 0000!
    1243 000030 ED31                          mov dbl (*(#_save_xar6)), xar6                  ; restore xar6
         000032 EF00 
         000034 0000!
    1244 000036 4E01                          aadd #1, sp
    1245              
    1246 ****** MACRO                         portRESTORE_FIRST_CONTEXT
    1246                                      .C54CM_off
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   24

    1246              ;                       .CPL_off
    1246                                      .ARMS_off
    1246                                      .align 4
    1246              
    1246              ; Restore context & return
    1246                                      ;CONTEXT_RESTORE
    1246              ;                       ASP
    1246              ;                       EALLOW
    1246              ;                       nop
    1246              ;                       nop
    1246              ;                       nop
    1246              ;                       nop
    1246 000038 4652                  bclr C54CM
    1246              ;               xssp = dbl(*(#_pxCurrentTCB))
    1246              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1246 00003a EB31                          mov xar7, dbl (*(#_save_xar7))  
         00003c F500 
         00003e 0000!
    1246              
    1246              ; ****************************************************************************
    1246              ; * Init Stack Pointer. Remember stack grows from high to low address *
    1246              ; ****************************************************************************
    1246              ;                       stm #_stack, sp ; set to begging of stack memory
    1246              ;                       addm #(_STACK_SIZE  1), *(SP) ; add size to get to the top
    1246              ;                       andm #0FFFEh, *(SP) ; make sure it is an even address
    1246              
    1246              ;                       aadd #-1, sp
    1246              ;            aadd #-3, xsp
    1246              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1246              ;            BCC $1,TC1 ; |216|
    1246 000040 ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
         000042 4F00 
         000044 0000!
    1246 000046 ED31                          mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
         000048 5F00 
         00004a 0000!
    1246              ;            B $4
    1246              
    1246              ;                       mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1246              ;                       mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1246              
    1246              ;;;                     aadd #-1, sp
    1246              ;$1
    1246              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1246              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1246              ;$4
    1246                                      .if 1
    1246 00004c 904F                          mov xsp, xar7
    1246 00004e 905E                          mov xssp, xar6
    1246 000050 EC31                          amov #0x000000, xar2
         000052 AE00 
         000054 0000 
    1246 000056 EC31                          amov #0x000000, xar1
         000058 9E00 
         00005a 0000 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   25

    1246 00005c EC31                          amov #0x000000, xar3
         00005e BE00 
         000060 0000 
    1246 000062 EC31                          amov #0x000000, xar4
         000064 CE00 
         000066 0000 
    1246              
    1246 000068 ED31                          mov dbl (*(#_pxCurrentTCB)), xar5                               
         00006a DF00 
         00006c 0000!
    1246              
    1246 00006e EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         000070 CF   
    1246 000071 EDAD                          mov dbl (*ar5(#2)), xar3                        ; xssp          
         000073 BF00 
         000075 02   
    1246                                      
    1246 000076 AA81                          mov *ar4, ar2
    1246 000078 A961                          mov *ar3, ar1
    1246              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1246 00007a CAE1                          mov ar2, *ar7
    1246 00007c C9C1                          mov ar1, *ar6   
    1246                                      .endif
    1246              
    1246              ;
    1246              ;                       amov #0x000000, xar7
    1246              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1246              
    1246              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1246              ;                       mov dbl (*ar7(#2)), xssp
    1246                                      .if 1
    1246 00007e EC31              amov #0x000000, xar7
         000080 FE00 
         000082 0000 
    1246 000084 AF06                      mov mmap(ST1_55), ar7
         000086 98   
    1246 000087 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         000089 FFFF 
    1246 00008b CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1246 00008d CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         00008f 0001 
    1246 000091 AF96                          mov mmap(ST2_55), ar7
         000093 98   
    1246 000094 CF04                          mov ar7, *sp(#2)
    1246 000096 CF8D                          mov ar7, *ar4(#2)
         000098 0002 
    1246 00009a EC31              amov #0x000000, xar6
         00009c EE00 
         00009e 0000 
    1246 0000a0 EC31                          amov #0x000000, xar7
         0000a2 FE00 
         0000a4 0000 
    1246              
    1246 0000a6 449F                          mov ssp, ar7
    1246 0000a8 AE04                          mov mmap(ST0_55), ar6
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   26

         0000aa 98   
    1246 0000ab CEED                          mov ar6, *ar7(#2)
         0000ad 0002 
    1246 0000af CE6D                          mov ar6, *ar3(#2)
         0000b1 0002 
    1246                                      
    1246 0000b3 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         0000b5 0000 
         0000b7 00!  
    1246 0000b8 CEED                          mov ar6, *ar7(#1)
         0000ba 0001 
    1246 0000bc CE6D                          mov ar6, *ar3(#1)
         0000be 0001 
    1246              
    1246                                      .endif
    1246              
    1246              ;                       mov #0, ssp     
    1246              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1246              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1246                                      ; 32-bit mode - will act on SP and SSP:
    1246              ;                       'fix-up' current SP and SSP - is this dangerous????
    1246              ;                       aadd #-3, sp
    1246              ;;                      mov *ar7, *sp
    1246              ;                       mov dbl (*ar7), ar6
    1246              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1246              ;                       mov *ar7(#2), *ssp                      
    1246              ;                       POP mmap(ST3_55)
    1246              ;                       pshboth xar7                            ; should increment both
    1246                                      .if 0
    1246                                      mov mmap(ST1_55), ar7
    1246                                      and #0xf7ff, ar7                        ; <here>#0800h
    1246                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1246                                      mov mmap(ST2_55), ar7
    1246                                      mov ar7, *sp(#2)
    1246              
    1246                                      mov ssp, ar7
    1246                                      mov mmap(ST0_55), ar6
    1246                                      mov ar6, *ar7(#2)
    1246                                      .endif
    1246              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1246              ;;                      mov ar6, *ar7(#1)
    1246              
    1246                                      .if 0
    1246                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1246              
    1246                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1246                                      mov dbl (*ar7(#2)), xssp        
    1246                                      .endif
    1246              
    1246                                      .if 0                                           ; first task - no pxcode update
    1246                                          mov dbl (*(_xCompareTCB)), xar6
    1246              ; need to restore our return address
    1246                                          mov xar7, ac0
    1246                                          mov xar6, ac1
    1246                                          CMPU AC1 != AC0, TC1 ; |1393|
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   27

    1246                                          BCC $7,TC1 ; |1393|
    1246                                          amov #0x000000, xar7
    1246                                          amov #0x000000, xar6
    1246                                          mov  *(#_save_new_pxcode), ar7
    1246                                          mov ar7, *sp(#0)
    1246                                          mov *(#_save_new_pxlcode) , ar7
    1246                                          mov ssp, ar6
    1246                                          mov ar7, *ar6(#0)
    1246              
    1246                                          mov dbl (*(#_save_xar6)), xar6
    1246                                          .endif
    1246 0000c0       $7_$1$:
    1246              
    1246              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1246              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1246                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1246                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1246                                      mov xar6, dbl (*(#_save_xar6))
    1246              
    1246              ;; this is for debug
    1246                                      mov dbl(*ar7), xar6
    1246                                      mov dbl(*ar6), xar7
    1246                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1246                                      mov xssp, xar7
    1246                                      mov dbl(*ar7), xar6
    1246                                      mov dbl(*ar6), xar7
    1246                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1246                                      mov xssp, xar7
    1246                                      add #-2, ar7
    1246                                      mov dbl(*ar7), xar6
    1246                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1246                                      mov dbl (*(#_save_xar6)), xar6
    1246                                      
    1246                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1246                                      .endif
    1246              
    1246              ;                       mov mmap(ST0_55), *ssp(#1)
    1246              ;                       mov mmap(STO_55), *ssp(#2)
    1246              ;                       mov mmap(ST1_55), *sp(#1)
    1246              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1246              ;                       mov *ar7, t0
    1246              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1246              ;                       mov *ar7(#2), t0
    1246              ;                       mov t0, *ssp(#0)                        
    1246              
    1246              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1246              ; what about xssp?
    1246              ;                       mov xar6, xsp
    1246              ;                       mov xssp, xar7
    1246              ;                       add #1, ar7
    1246              ;                       mov xar7, xsp
    1246              ;                       mov sp, t0
    1246              ;                       mov ssp, t1
    1246              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1246              ;                       ar0 = *ar6
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   28

    1246              ;                       xssp = xar0
    1246              ;                       mov *xar6, xar0
    1246              ;                       mov xar0, xssp  ; stack now points to our TCB
    1246              ;;                      mov sp, *ar6
    1246              ;;                      mov sp, ar0
    1246              ;;                      mov sp, *_pxCurrentTCB
    1246              ;;                      clr ar0
    1246              ;;                      mov ar0, @xar6
    1246              ;;                      mov sp, AR0
    1246              ;;                      add sp, xar6
    1246              
    1246              ;;                      pshboth xar7
    1246              ;;                      pshboth xar6
    1246              ;;                      pshboth xar5
    1246              
    1246              ;;                      popboth xar5
    1246              ;;                      popboth xar6
    1246              ;;                      popboth xar7
    1246              
    1246              ;;;                     mov *sp(#1), ar7 
    1246              ;                       mov dbl(*sp(#1)), ar7
    1246              ;;;                     mov  ar7, mmap(ST1_55)
    1246              
    1246 0000c0 EC31                          amov #0x000000, xar7
         0000c2 FE00 
         0000c4 0000 
    1246 0000c6 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         0000c8 FF00 
         0000ca 0000!
    1246 0000cc EDE1                          mov dbl (*ar7), xsp                             ; xsp contains our TCB now
         0000ce 4F   
    1246 0000cf EDED                          mov dbl (*ar7(#2)), xssp        
         0000d1 5F00 
         0000d3 02   
    1246              
    1246                                      .if 0
    1246                                      mov *sp(#2), ar7
    1246                                      mov ar7, mmap(ST2_55)
    1246                                      mov ssp, ar7
    1246                                      mov *ar7(#2), ar6
    1246                                      mov ar6, mmap(ST0_55)
    1246                                      .endif
    1246              ;                       mov *ar7(#2), ar6
    1246              ;                       mov ar6, *ssp(#2)
    1246              ;                       mov *ssp(#2), ar7
    1246              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1246              
    1246 0000d4 EC31              amov #0x000000, xar7
         0000d6 FE00 
         0000d8 0000 
    1246 0000da EC31                          amov #0x000000, xar6
         0000dc EE00 
         0000de 0000 
    1246                                      .if 0
    1246                                      mov mmap(ST1_55), ar7
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   29

    1246                                      and #0xf7ff, ar7                        ; <here>#0800h
    1246                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1246              ;                       mov ar7, *ar4(#1)                       ; save in TCB
    1246                          amov #0x000000, xar7
    1246                                      mov mmap(ST2_55), ar7
    1246                                      mov ar7, *sp(#2)
    1246              ;                       mov ar7, *ar4(#2)
    1246                          amov #0x000000, xar7
    1246                          amov #0x000000, xar6
    1246                                      mov ssp, ar7
    1246                                      mov mmap(ST0_55), ar6
    1246                                      mov ar6, *ar7(#2)
    1246              ;                       mov ar6, *ar3(#2)
    1246                                      mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
    1246                                      mov ar6, *ar7(#1)
    1246              ;                       mov ar6, *ar3(#2)
    1246                                      .endif
    1246              ;                       mov *(#_LOOP_BITS), ar6         ; have to restore this
    1246              ;                       and #0xFF00, ar6
    1246              ;                       mov ar6, *ar7(#2)
    1246              
    1246 0000e0 EC31              amov #0x000000, xar7
         0000e2 FE00 
         0000e4 0000 
    1246 0000e6 ED08                          mov dbl(*sp(#4)), xar7
         0000e8 FF   
    1246              ;                       mov *sp(#1), ar7
    1246 0000e9 EB31                          mov xar7, dbl(*(#_usCriticalNesting))   
         0000eb F500 
         0000ed 0000!
    1246 0000ef EC31              amov #0x000000, xar6
         0000f1 EE00 
         0000f3 0000 
    1246 0000f5 ED0C                          mov dbl(*sp(#6)), xar6
         0000f7 EF   
    1246              ;                       mov *sp(#3), ar6
    1246              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1246 0000f8 EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
         0000fa E500 
         0000fc 0000!
    1246              
    1246              ;                       POP XT
    1246                              ;-- Comment these to save cycles ---
    1246 0000fe ED10                          mov dbl(*sp(#8)), xar7
         000100 FF   
    1246 000101 AF0E                          mov *sp(#7), ar7
    1246              ;                       mov *sp(#5), ar7
    1246              ;                       mov dbl(*sp(#0)), hi(ar7)
    1246              ;                       mov (*sp(#0)), lo(ar7)
    1246 000103 ED14                          mov dbl(*sp(#10)), xar6
         000105 EF   
    1246 000106 AE12                          mov *sp(#9), ar6
    1246 000108 ED18                          mov dbl(*sp(#12)), xar5
         00010a DF   
    1246 00010b AD16                          mov *sp(#11), ar5
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   30

    1246              ;; pvPararmeters currently here - needs to be verified --- jcw
    1246 00010d ED1C                          mov dbl(*sp(#14)), xar4
         00010f CF   
    1246 000110 AC1A                          mov *sp(#13), ar4
    1246 000112 ED20                          mov dbl(*sp(#16)), xar3
         000114 BF   
    1246 000115 AB1E                          mov *sp(#15), ar3
    1246 000117 ED24                          mov dbl(*sp(#18)), xar2
         000119 AF   
    1246 00011a AA22                          mov *sp(#17), ar2
    1246 00011c ED28                          mov dbl(*sp(#20)), xar1
         00011e 9F   
    1246 00011f A926                          mov *sp(#19), ar1
    1246 000121 ED2C                          mov dbl(*sp(#22)), xar0
         000123 8F   
    1246 000124 A82A                          mov *sp(#21), ar0
    1246 000126 ED30              mov dbl(*sp(#24)), ac0
         000128 08   
    1246 000129 A02E              mov *sp(#23), ac0
    1246              
    1246 00012b A732                          mov *sp(#25), t3
    1246 00012d A634                          mov *sp(#26), t2
    1246 00012f A536                          mov *sp(#27), t1
    1246 000131 A438                          mov *sp(#28), t0
    1246              
    1246              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1246              ;                       mov *sp(#21), *ssp
    1246              ;                       mov *sp(#21), RETA
    1246              ; need to move 23-16 to XSSP contents
    1246              ;                       mov xar0, dbl (*(#_save_xar7))
    1246              ;                       mov ssp, ar0
    1246              ;                       mov #0, ssp 
    1246              ;                       mov xssp, xar0
    1246              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1246              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1246                      ;               add #1, xssp            ; 32-bit return address pointer
    1246                      ;               amar *xssp+
    1246              ;                       mov sp, t0
    1246              ;                       add #1, t0
    1246              ;                       mov t0, ssp
    1246              ;                       incr ssp
    1246              ;                       asub #20, ar0
    1246              ;                       mov xar0, xssp
    1246              ;                       mov ar0, ssp
    1246              ;                       mov ar0, 
    1246              ;;                      mov *sp(#1), t0
    1246              ;;                      mov *sp(#3), t3         ; ST0
    1246              ;;                      mov *sp(#4), t2         ; DBSTAT
    1246              ;;                      mov t3, *ar0(#2)
    1246                      ;;              mov t2, *ar0(#1)
    1246              ;;                      mov t0, *ar0(#0)
    1246              
    1246              ;;                      mov *sp(#5), t0
    1246              ;;                      mov *sp(#6), t1
    1246              ;;                      mov *sp(#7), t2
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   31

    1246                      ;;              mov *sp(#8), t3
    1246              
    1246              ; restore ar0
    1246              ;                       mov dbl(*sp(#-2)), xar0
    1246              ;                       mov #-1, ar0
    1246              ;;                      mov dbl (*(#_save_xar7)), xar0
    1246              ;;
    1246              ;;                      mov sp, t0
    1246              ;;                      add #1, t0
    1246              ;;                      mov t0, ssp
    1246              
    1246              ;                       mov *sp(#3), *(#00004ch+#1)
    1246              
    1246              ;                       mov t3, *ssp(#1) 
    1246              ;                       mov t2, *ssp(#2)
    1246              
    1246              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1246              ;;                      mov t3, *(ssp(#0))
    1246              ;                       mov t3, *ssp
    1246              ;                       mov *sp(#3), t3 ; 
    1246              ;                       mov t3, *ssp(#1)
    1246              ;;                      mov *sp(#21), PC        
    1246              
    1246              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1246              ;                       mov dbl(xsp), dbl(lcrpc)
    1246              ;                       popboth XAR7
    1246              ;                       add #1, sp
    1246              ;                       add #1, ssp
    1246              ;                       add #2, t0
    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246              ;                       popboth XAR6
    1246              ;                       add #2, t0
    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246              ;                       popboth XAR5
    1246              ;                       add #2, t0
    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246                              ;-----------------------------------
    1246              ;                       popboth XAR4
    1246              ;                       add #2, t0
    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246              ;                       popboth XAR3
    1246              ;                       add #2, t0
    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246              ;                       popboth XAR2
    1246              ;                       add #2, t0
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   32

    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246              ;                       popboth XAR1
    1246              ;                       add #2, t0
    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246              ;                       popboth XAR0
    1246              ;                       add #2, t0
    1246              ;                       add #2, t1
    1246              ;                       mov t0, sp
    1246              ;                       mov t1, ssp
    1246              ;                       EDIS
    1246              ;                       NASP    ; Un-align stack pointer
    1246              ;;                      pop mmap(ST3_55)
    1246              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1246              ;            BCC $2,TC1 ; |216|
    1246                                      .if 0
    1246                                      amov #0x000000, xar7
    1246                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1246              
    1246                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1246                                      mov dbl (*ar7(#2)), xssp                
    1246                                      .endif
    1246              
    1246 000133 ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
         000135 4F00 
         000137 0000!
    1246 000139 ED31                          mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
         00013b 5F00 
         00013d 0000!
    1246              
    1246                                      .if 0
    1246                                      mov dbl (*(_xCompareTCB)), xar6
    1246              ; need to restore our return address
    1246                                      mov xar7, ac0
    1246                          mov xar6, ac1
    1246                              CMPU AC1 != AC0, TC1 ; |1393|
    1246                          BCC $6,TC1 ; |1393|
    1246                          amov #0x000000, xar7
    1246                                      amov #0x000000, xar6
    1246                          mov  *(#_save_new_pxcode), ar7
    1246                                      mov ar7, *sp(#0)
    1246                          mov *(#_save_new_pxlcode) , ar7
    1246                          mov ssp, ar6
    1246                          mov ar7, *ar6(#0)
    1246              
    1246                          mov dbl (*(#_save_xar6)), xar6
    1246                                      .endif
    1246              
    1246 00013f ED31                          mov dbl (*(#_save_xar7)), xar7
         000141 FF00 
         000143 0000!
    1246              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   33

    1246              ;                       B $3
    1246              ;$2
    1246              ;            MOV #0, *(#_first_flag) ; |217|
    1246              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1246              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1246              ;$3
    1246              ;                       aadd #-3, sp
    1246              ;                       aadd #1, sp
    1246 000145 46B2                          bclr INTM               ; enable interrupts
    1246              ;                       aadd #1, sp
    1246 000147 4805                          RETI
    1246              ;                       mov #1860h, ssp
    1246 000149 20                            nop
    1246 00014a 20                            nop
    1246              ;                       nop
    1247              
    1248              
    1249 00014b       _vTickISR:              ; the timer ISR is aggregated for this processor architecture
    1250               ;               bclr IFR0.IF4          ; enable interrupts
    1251              
    1252 00014b 4EFF                  aadd #-1, sp                                            ;;
    1253 00014d E651                  MOV #0, *port(#6166) ; |119|
         00014f 0018 
         000151 16   
    1254 000152 F402                  AND #0x0010, mmap(@IFR0)
         000154 0010 
         000156 98   
    1255 000157 46B3                  bset INTM
    1256              ;           MOV *port(#7188), AR1 ; |68|                ;; TIMER0 is only timer that is active
    1257              ;        BSET @#0, AR1 ; |68|
    1258              ;        BCC $1,AR1 == #0 ; |68|
    1259              ;        AND #0x0010, *(#1)
    1260              
    1261              ;               bset INTM               ; disable interrupts
    1262                              .if configUSE_TICK_CTR == 1
    1263 000159 F731                  add #1, *(#_tickIRQctr)
         00015b 0001 
         00015d 0000 
         00015f 00!  
    1264                              .endif
    1265              ;;              psh mmap(ST3_55)
    1266                  .if 1
    1267 000160 EB31                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         000162 F500 
         000164 0000!
    1268 000166 EB31                          mov xar6, dbl (*(#_save_xar6))                  ; save x
         000168 E500 
         00016a 0000!
    1269              
    1270 00016c EC31                                                  amov #0x000000, xar7
         00016e FE00 
         000170 0000 
    1271 000172 EC31                                                  amov #0x000000, xar6
         000174 EE00 
         000176 0000 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   34

    1272              
    1273              
    1274 000178 AF02                          mov *sp(#1), ar7                                            ;; sp+3
    1275 00017a CF31                          mov ar7, *(#_save_new_pxcode)
         00017c 0000 
         00017e 00!  
    1276 00017f 449E                          mov ssp, ar6
    1277 000181 AFCD                          mov *ar6(#1), ar7                                                       ;; ssp+3
         000183 0001 
    1278 000185 CF31                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and i
         000187 0000 
         000189 00!  
    1279                                   ;   nop
    1280 00018a ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         00018c FF00 
         00018e 0000!
    1281 000190 EB31                          mov xar7, dbl(*(#_xCompareTCB))
         000192 F500 
         000194 0000!
    1282                                      .endif
    1283                      .if 1
    1284                      ;               mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1285                  ;        mov xar6, dbl (*(#_save_xar6))
    1286 000196 EC31                          amov #0x000000, xar7
         000198 FE00 
         00019a 0000 
    1287 00019c EC31                          amov #0x000000, xar6
         00019e EE00 
         0001a0 0000 
    1288 0001a2 449F                          mov ssp, ar7
    1289 0001a4 AEED                          mov *ar7(#2), ar6                               ; this is two away now
         0001a6 0002 
    1290 0001a8 CE31                          mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
         0001aa 0000 
         0001ac 00!  
    1291                                      .endif
    1292                          ;;            mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1293                          ;;            mov dbl (*(#_save_xar6)), xar6                  ; restore xar6
    1294              ;;              mov xsp, dbl (*(#_save_xsp))
    1295              ;;              mov xssp, dbl (*(#_save_xssp))
    1296 ****** MACRO         portSAVE_CONTEXT
    1296              ;                       ;CONTEXT_SAVE
    1296              ;                       ASP  ; Align Stack Pointer
    1296              ;                       CLRC       OVM,PAGE0
    1296              ;                       CLRC       AMODE
    1296              ;                       EALLOW
    1296 0001ad 4652                  bclr C54CM      ; temp - until we figure out what is setting this
    1296              ;;;             bset INTM               ; disable interrupts - already done
    1296              ;                       aadd #1, sp
    1296              ;                       mov xsp,  dbl (*(#_save_xsp))                   ; save xsp
    1296              ;                       mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1296              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1296              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1296              
    1296              ;                       pshboth xar7
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   35

    1296              ;                       pshboth xar6
    1296              ;                       pshboth xar5
    1296              
    1296 0001af EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         0001b1 F500 
         0001b3 0000!
    1296              ;                       .if configUSE_CONTEXT_DEBUG == 1
    1296 0001b5 EB31                          mov xar6, dbl (*(#_save_xar6))
         0001b7 E500 
         0001b9 0000!
    1296              ;                       .endif
    1296 0001bb 4E01                          aadd #1, sp
    1296              ; +++===+++
    1296              
    1296                                      .if 0
    1296                                      amov #0x000000, xar7
    1296                                      amov #0x000000, xar6
    1296                                      mov xsp, xar7
    1296                                      mov xssp, xar6
    1296                                      amov #0x000000, xar2
    1296                                      amov #0x000000, xar1
    1296                                      mov dbl (*(#_pxCurrentTCB)), xar5
    1296              
    1296                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
    1296                                      mov dbl (*ar5(#2)), xar3
    1296              
    1296                                      mov *ar7, ar2                           ; current xsp contents
    1296                                      mov *ar6, ar1                           ; current xssp contents
    1296              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1296                                      mov ar2, *ar4
    1296                                      mov ar1, *ar3
    1296                                      .endif
    1296              
    1296                                      .if 1
    1296              
    1296 0001bd ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         0001bf FF00 
         0001c1 0000!
    1296 0001c3 EDA1                          mov dbl (*ar5), xsp                             ; xsp contains our TCB now
         0001c5 4F   
    1296 0001c6 EDAD                          mov dbl (*ar5(#2)), xssp
         0001c8 5F00 
         0001ca 02   
    1296 0001cb EC31              amov #0x000000, xar7
         0001cd FE00 
         0001cf 0000 
    1296 0001d1 EC31                          amov #0x000000, xar6
         0001d3 EE00 
         0001d5 0000 
    1296 0001d7 CF31              mov ar7, *(#_save_new_pxcode)
         0001d9 0000 
         0001db 00!  
    1296 0001dc 449E              mov ssp, ar6
    1296 0001de AFCD              mov *ar6(#1), ar7                                                       ;; ssp+3
         0001e0 0001 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   36

    1296 0001e2 CF31              mov ar7, *(#_save_new_pxlcode)
         0001e4 0000 
         0001e6 00!  
    1296                                      .endif
    1296              
    1296              ;                       mov ssp, ar7
    1296              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
    1296              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1296              ;                       .endif
    1296              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1296              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
    1296                                      .if 0
    1296                                      amov #0x000000, xar7
    1296                                      amov #0x000000, xar6
    1296                          mov *sp(#0), ar7                                            ;; sp+3
    1296                          mov ar7, *(#_save_new_pxcode)
    1296                          mov ssp, ar6
    1296                          mov *ar6(#1), ar7                                                       ;; ssp+3
    1296                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
    1296                                   ;   nop
    1296                          mov dbl (*(#_pxCurrentTCB)), xar7
    1296                          mov xar7, dbl(*(#_xCompareTCB))
    1296                          .endif
    1296              ; +++===+++
    1296              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1296              ;
    1296 0001e7 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         0001e9 FF00 
         0001eb 0000!
    1296 0001ed EDE1                          mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
         0001ef 4F   
    1296 0001f0 EDED                          mov dbl (*ar7(#2)), xssp
         0001f2 5F00 
         0001f4 02   
    1296              ; +++===+++
    1296                                      .if 0
    1296              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
    1296              ;                       mov xar7, ac0
    1296              ;               mov xar6, ac1
    1296              ;                       CMPU AC1 != AC0, TC1
    1296              ;                               BCC $5,TC1
    1296                                      amov #0x000000, xar7
    1296                                          amov #0x000000, xar6
    1296                                          mov  *(#_save_new_pxcode), ar7
    1296                                          mov ar7, *sp(#0)
    1296                              mov *(#_save_new_pxlcode) , ar7
    1296                              mov ssp, ar6
    1296                              mov ar7, *ar6(#0)
    1296                              mov dbl (*(#_save_xar6)), xar6
    1296                                         .endif
    1296              ; +++===+++
    1296 0001f5       $5_$2$:
    1296                                              
    1296              ; +++===+++
    1296              ;; what about xssp here?
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   37

    1296              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1296              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1296                                 .if configUSE_CONTEXT_DEBUG == 1
    1296              ;; save current PC (and possible loop bits values)
    1296              ;; for debug - to see if this is being corrupted
    1296                                      mov dbl(*ar7), xar6
    1296                                      mov dbl(*ar6), xar7
    1296                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
    1296                                      mov xssp, xar7
    1296                                      mov dbl(*ar7), xar6
    1296                                      mov dbl(*ar6), xar7
    1296                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
    1296                                      mov xssp, xar7
    1296                                      add #-2, ar7
    1296                                      mov dbl(*ar7), xar6
    1296                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
    1296                          mov dbl (*(#_save_xar6)), xar6
    1296              
    1296              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
    1296              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
    1296              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
    1296                                      .endif
    1296              ; +++===+++
    1296                                      ; save context in our stack(s) frame
    1296              
    1296              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
    1296              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1296              ;;;                     mov dbl (*ar7(#2)), xssp
    1296              ; +++===+++
    1296              
    1296 0001f5 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         0001f7 FF00 
         0001f9 0000!
    1296 0001fb ED31              mov dbl (*(#_save_xar6)), xar6
         0001fd EF00 
         0001ff 0000!
    1296                                        ; restore xar6
    1296              ;;; begin context save:
    1296              
    1296 000201 EB10                          mov xar7, dbl(*sp(#8))                          ; save xar7
         000203 F5   
    1296 000204 CF0E                          mov ar7, *sp(#7)
    1296              
    1296 000206 EB14                          mov xar6, dbl(*sp(#10))
         000208 E5   
    1296 000209 CE12                          mov ar6, *sp(#9)
    1296              
    1296 00020b EB18                          mov xar5, dbl(*sp(#12))
         00020d D5   
    1296 00020e CD16                          mov ar5, *sp(#11)
    1296              
    1296 000210 EB1C                          mov xar4, dbl(*sp(#14))
         000212 C5   
    1296 000213 CC1A                          mov ar4, *sp(#13)
    1296              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   38

    1296 000215 EB20                          mov xar3, dbl(*sp(#16))
         000217 B5   
    1296 000218 CB1E                          mov ar3, *sp(#15)
    1296              
    1296 00021a EB24                          mov xar2, dbl(*sp(#18))
         00021c A5   
    1296 00021d CA22                          mov ar2, *sp(#17)
    1296              
    1296 00021f EB28                          mov xar1, dbl(*sp(#20))
         000221 95   
    1296 000222 C926                          mov ar1, *sp(#19)
    1296              
    1296 000224 EB2C                          mov xar0, dbl(*sp(#22))
         000226 85   
    1296 000227 C82A                          mov ar0, *sp(#21)
    1296              
    1296 000229 EB30              mov  ac0, dbl(*sp(#24))
         00022b 08   
    1296 00022c C02E              mov ac0, *sp(#23)
    1296              
    1296 00022e C732                          mov t3, *sp(#25)
    1296 000230 C634                          mov t2, *sp(#26)
    1296 000232 C536                          mov t1, *sp(#27)
    1296 000234 C438                          mov t0, *sp(#28)
    1296              ; +++===+++
    1296              ;;                      mov mmap(ST0_55), t0
    1296              ; - this is ok - we are not pushing - it's a relative stack frame
    1296              ;                       mov t0, *sp(#25)
    1296              ;;                      mov t0, *sp(#23)
    1296              ;;                      mov mmap(ST1_55), t1
    1296              ;                       mov t1, *sp(#26)                ; stomping on own mem
    1296              ;;                      mov t1, *sp(#21)                ; stomping on own mem
    1296              ;;                      mov mmap(ST2_55), t2
    1296              ;;                      mov t2, *sp(#22)
    1296              ;                       mov t2, *sp(#27)
    1296              ;;                      mov mmap(ST2_55), t3
    1296              ;                       mov t3, *sp(#28)
    1296              ;;                      mov t3, *sp(#24)
    1296              
    1296              ;                       PSH dbl(AR0) ; 32-bit
    1296              ;                       PSH dbl(AR1) 
    1296              ;                       PSH dbl(AR2) ; 32-bit
    1296              ;                       PUSH XAR3 ; 32-bit
    1296              ;                       PUSH XAR4 ; 32-bit
    1296                              ;-- Comment these to save cycles --------
    1296              ;                       PUSH XAR5 ; 32-bit
    1296              ;                       PUSH XAR6 ; 32-bit
    1296              ;                       PUSH XAR7 ; 32-bit
    1296                              ;----------------------------------------
    1296              
    1296              ;                       PUSH XT   ; 32-bit
    1296              
    1296              ;                       movl xar6, @_portFLAGS_INT_ENABLED
    1296              ;                       push xar6 ; portFLAGS_INT_ENABLED
    1296              ; +++===+++
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   39

    1296              
    1296 000236 ED31                          mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
         000238 EF00 
         00023a 0000!
    1296 00023c EB0C                          mov xar6, dbl(*sp(#6))
         00023e E5   
    1296                                      
    1296              
    1296              ;                       movl xar7, @_usCriticalNesting
    1296              ;                       push xar7
    1296 00023f ED31                          mov dbl (*(#_usCriticalNesting)), xar7
         000241 FF00 
         000243 0000!
    1296 000245 EB08                          mov xar7, dbl(*sp(#4))
         000247 F5   
    1296              
    1296 000248 EC31                          amov #0x000000, xar7
         00024a FE00 
         00024c 0000 
    1296 00024e EC31                          amov #0x000000, xar6
         000250 EE00 
         000252 0000 
    1296              
    1296 000254 AF06                          mov mmap(ST1_55), ar7
         000256 98   
    1296 000257 CF02                          mov ar7, *sp(#1)
    1296 000259 AF96                          mov  mmap(ST2_55), ar7
         00025b 98   
    1296 00025c CF04                          mov ar7, *sp(#2)
    1296              
    1296 00025e 449F                          mov ssp, ar7
    1296              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
    1296              ;                       and #0xFF00, ar6
    1296              ;                       mov ar6, *ar7(#1)
    1296              
    1296 000260 AE04                          mov mmap(ST0_55), ar6
         000262 98   
    1296 000263 CEED                          mov ar6, *ar7(#2)
         000265 0002 
    1296                                      
    1296 000267 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
         000269 0000 
         00026b 00!  
    1296 00026c CEED                          mov ar6, *ar7(#1)
         00026e 0001 
    1296              ; +++===+++
    1296              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1296              ;                       mov dbl (*(#_save_xssp)), xssp          
    1296              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
    1296              ;;;                     mov ar6, *ar7(#2)
    1296              ;                       mov ar7, mmap(ST0_55)
    1296              ;                       mov *ssp(#2), ar7
    1296              ; fix up
    1296              ;                       aadd #20, sp
    1296              ;                       mov sp, t0
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   40

    1296              ;                       sub #1, t0
    1296              ;                       mov t0, ssp
    1296              
    1296                                      ; move contents of SP into address of current TCB
    1296              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
    1296              
    1296              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1296              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1296              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1296              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1296              ;                       mov dbl (*ar7+), xssp
    1296              
    1296              ;                       mov sp, t0              ; we've already saved t0
    1296              ;                       add #1, t0
    1296              ;                       mov t0, ssp
    1296              ; ??
    1296              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
    1296              
    1296              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
    1296              ;                       mov al, @sp
    1296              ;                       movl  *xar6, acc        
    1296              ;;                      mov  ar0, @sp
    1296              ;;                      mov  @ar6, alxd
    1296              ;;                      mov  ar0, @sp
    1296              ;;                      movl 0(xar6), sp
    1296              ;                       EDIS
    1296              ;                       NASP
    1296              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1296              ;                       NOP
    1296 000270 ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
         000272 4F00 
         000274 0000!
    1296 000276 ED31                          mov dbl (*(#_save_xssp)), xssp                  ; restore xssp
         000278 5F00 
         00027a 0000!
    1296 00027c 20                            nop
    1296              ;                       aadd #-1, sp
    1296 00027d 20                            nop
    1296              
    1296 00027e 20                            nop
    1296                                                                                      ; ?
    1297              ;        aadd #1, sp
    1298 00027f 6C00          call     #_xTaskIncrementTick
         000281 0000!
    1299              ;        aadd #-1, sp
    1300                      .if configUSE_PREEMPTION == 1
    1301              ;        mov xsp, dbl (*(#_save_xsp))                   ; save xsp
    1302              ;           mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1303              ;        aadd #1, sp
    1304 000283 6C00          call    #_vTaskSwitchContext
         000285 0000!
    1305              ;        aadd #-1, sp
    1306              
    1307                                      .if 1
    1308 000287 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   41

         000289 F500 
         00028b 0000!
    1309 00028d EB31              mov xar6, dbl (*(#_save_xar6))
         00028f E500 
         000291 0000!
    1310 000293 EB31              mov ac0, dbl (*(#_save_ac0))                  ; save xar7
         000295 0800 
         000297 0000!
    1311 000299 EB31              mov ac1, dbl (*(#_save_ac1))
         00029b 1800 
         00029d 0000!
    1312 00029f EC31              amov #0x000000, xar7
         0002a1 FE00 
         0002a3 0000 
    1313 0002a5 EC31                          amov #0x000000, xar6
         0002a7 EE00 
         0002a9 0000 
    1314 0002ab ED31                          mov dbl (*(_xCompareTCB)), xar6
         0002ad EF00 
         0002af 0000!
    1315 0002b1 ED31                      mov dbl (*(#_pxCurrentTCB)), xar7
         0002b3 FF00 
         0002b5 0000!
    1316                          ; need to restore our return address
    1317 0002b7 3C00              mov #0x000000, ac0
    1318 0002b9 3C01                          mov #0x000000, ac1
    1319 0002bb 90F0                          mov xar7, ac0
    1320 0002bd 90E1              mov xar6, ac1
    1321 0002bf 1210                  CMPU AC1 == AC0, TC1 ; |1393|
         0002c1 04   
    1322 0002c2 6464              BCC $A,TC1 ; |1393|
    1323 0002c4 20                nop                 ; breakpoint here
    1324                          .if configUSE_TICK_CTR == 1
    1325 0002c5 F731                      add #1, *(#_context_switch_counter)
         0002c7 0001 
         0002c9 0000 
         0002cb 00!  
    1326                                  .endif
    1327                              ; amov #0x000000, xar7
    1328                                      ;    amov #0x000000, xar6
    1329                          ;  mov  *(#_save_new_pxcode), ar7
    1330                                      ;    mov ar7, *sp(#0)
    1331                          ;                mov *(#_save_new_pxlcode) , ar7
    1332                          ;                mov ssp, ar6
    1333                          ;                mov ar7, *ar6(#0)
    1334              
    1335                          ;                mov dbl (*(#_save_xar6)), xar6
    1336                                      ;                       .endif
    1337              ; +++===+++
    1338 0002cc       $A:
    1339 0002cc ED31              mov dbl (*(#_save_ac0)), ac0                  ; save xar7
         0002ce 0800 
         0002d0 0000!
    1340 0002d2 ED31              mov dbl (*(#_save_ac1)), ac1
         0002d4 1800 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   42

         0002d6 0000!
    1341 0002d8 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         0002da FF00 
         0002dc 0000!
    1342 0002de ED31              mov dbl (*(#_save_xar6)), xar6
         0002e0 EF00 
         0002e2 0000!
    1343                       .endif
    1344                      .endif
    1345              ;$1:
    1346              ;               bclr INTM
    1347 0002e4 E651                  mov #1, *port(#6166) ; |127|
         0002e6 0118 
         0002e8 16   
    1348              ;               MOV #0, *port(#6294) ; |92|
    1349 0002e9 F551                  or #0x0001, *port(#7188) ; |130|
         0002eb 0001 
         0002ed 1C14 
    1350               ;       OR #0x0007, *port(#7188) ; |100|
    1351 0002ef 4E01              aadd #1, sp
    1352 ****** MACRO         portRESTORE_CONTEXT
    1352                                      .C54CM_off
    1352              ;                       .CPL_off
    1352                                      .ARMS_off
    1352                                      .align 4
    1352              
    1352              ; Restore context & return
    1352                                      ;CONTEXT_RESTORE
    1352              ;                       ASP
    1352              ;                       EALLOW
    1352              ;                       nop
    1352              ;                       nop
    1352              ;                       nop
    1352              ;                       nop
    1352 0002f4 4652                  bclr C54CM
    1352              ;               xssp = dbl(*(#_pxCurrentTCB))
    1352              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1352 0002f6 EB31                          mov xar7, dbl (*(#_save_xar7))  
         0002f8 F500 
         0002fa 0000!
    1352 0002fc EB31                          mov xar6, dbl (*(#_save_xar6))
         0002fe E500 
         000300 0000!
    1352              
    1352 000302 4EFF                          aadd #-1, sp
    1352              ;            aadd #-3, xsp
    1352              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1352              ;            BCC $1,TC1 ; |216|
    1352 000304 ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
         000306 4F00 
         000308 0000!
    1352 00030a ED31                          mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
         00030c 5F00 
         00030e 0000!
    1352              ;            B $4
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   43

    1352              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1352              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1352              
    1352              ;;                      aadd #1, sp
    1352              ;$1
    1352              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1352              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1352              ;$4
    1352                                      .if 1
    1352 000310 904F                          mov xsp, xar7
    1352 000312 905E                          mov xssp, xar6
    1352 000314 EC31                          amov #0x000000, xar2
         000316 AE00 
         000318 0000 
    1352 00031a EC31                          amov #0x000000, xar1
         00031c 9E00 
         00031e 0000 
    1352 000320 ED31                          mov dbl (*(#_pxCurrentTCB)), xar5                       
         000322 DF00 
         000324 0000!
    1352              
    1352 000326 EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         000328 CF   
    1352 000329 EDAD                          mov dbl (*ar5(#2)), xar3                        
         00032b BF00 
         00032d 02   
    1352                                      
    1352 00032e AA81                          mov *ar4, ar2
    1352 000330 A961                          mov *ar3, ar1
    1352              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1352 000332 CAE1                          mov ar2, *ar7
    1352 000334 C9C1                          mov ar1, *ar6
    1352              
    1352 000336 AF06                          mov mmap(ST1_55), ar7
         000338 98   
    1352 000339 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         00033b FFFF 
    1352 00033d CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1352 00033f CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         000341 0001 
    1352 000343 AF96                          mov mmap(ST2_55), ar7
         000345 98   
    1352 000346 CF04                          mov ar7, *sp(#2)
    1352 000348 CF8D                          mov ar7, *ar4(#2)
         00034a 0002 
    1352              
    1352 00034c 449F                          mov ssp, ar7
    1352 00034e AE04                          mov mmap(ST0_55), ar6
         000350 98   
    1352 000351 CEED                          mov ar6, *ar7(#2)
         000353 0002 
    1352 000355 CE6D                          mov ar6, *ar3(#2)
         000357 0002 
    1352 000359 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         00035b 0000 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   44

         00035d 00!  
    1352 00035e CEED                          mov ar6, *ar7(#1)
         000360 0001 
    1352 000362 CE6D                          mov ar6, *ar3(#1)
         000364 0001 
    1352                                      .endif
    1352              
    1352              ;                       mov #0, ssp     
    1352              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1352              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1352                                      ; 32-bit mode - will act on SP and SSP:
    1352              ;                       'fix-up' current SP and SSP - is this dangerous????
    1352              ;                       aadd #-3, sp
    1352              ;;                      mov *ar7, *sp
    1352              ;                       mov dbl (*ar7), ar6
    1352              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1352              ;                       mov *ar7(#2), *ssp                      
    1352              ;                       POP mmap(ST3_55)
    1352              ;                       pshboth xar7                            ; should increment both
    1352                                      .if 0
    1352                                      mov mmap(ST1_55), ar7
    1352                                      and #0xf7ff, ar7                        ; <here>#0800h
    1352                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1352                                      mov mmap(ST2_55), ar7
    1352                                      mov ar7, *sp(#2)
    1352              
    1352                                      mov ssp, ar7
    1352                                      mov mmap(ST0_55), ar6
    1352                                      mov ar6, *ar7(#2)
    1352              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1352              ;;                      mov ar6, *ar7(#1)
    1352                                      .endif
    1352              ; +++===+++
    1352                                      .if 0
    1352                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1352                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1352                                      mov dbl (*ar7(#2)), xssp        
    1352                                      .endif
    1352              ; +++===+++
    1352                                      .if 0
    1352                                      mov dbl (*(_xCompareTCB)), xar6
    1352              ; need to restore our return address
    1352                                      mov xar7, ac0
    1352                                          mov xar6, ac1
    1352                                          CMPU AC1 != AC0, TC1 ; |1393|
    1352                                          BCC $6,TC1 ; |1393|
    1352                                          amov #0x000000, xar7
    1352                                          amov #0x000000, xar6
    1352                                          mov  *(#_save_new_pxcode), ar7
    1352                                          mov ar7, *sp(#0)
    1352                                          mov *(#_save_new_pxlcode) , ar7
    1352                                          mov ssp, ar6
    1352                                          mov ar7, *ar6(#0)
    1352              
    1352                                          mov dbl (*(#_save_xar6)), xar6
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   45

    1352                                                              .endif
    1352              ; +++===+++
    1352 000366       $6_$3$:
    1352              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1352              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1352                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1352                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1352                                      mov xar6, dbl (*(#_save_xar6))
    1352              
    1352              ;; this is for debug
    1352                                      mov dbl(*ar7), xar6
    1352                                      mov dbl(*ar6), xar7
    1352                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1352                                      mov xssp, xar7
    1352                                      mov dbl(*ar7), xar6
    1352                                      mov dbl(*ar6), xar7
    1352                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1352                                      mov xssp, xar7
    1352                                      add #-2, ar7
    1352                                      mov dbl(*ar7), xar6
    1352                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1352                                      mov dbl (*(#_save_xar6)), xar6
    1352                                      
    1352                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1352                                      .endif
    1352              ; +++===+++
    1352              ;                       mov mmap(ST0_55), *ssp(#1)
    1352              ;                       mov mmap(STO_55), *ssp(#2)
    1352              ;                       mov mmap(ST1_55), *sp(#1)
    1352              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1352              ;                       mov *ar7, t0
    1352              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1352              ;                       mov *ar7(#2), t0
    1352              ;                       mov t0, *ssp(#0)                        
    1352              
    1352              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1352              ; what about xssp?
    1352              ;                       mov xar6, xsp
    1352              ;                       mov xssp, xar7
    1352              ;                       add #1, ar7
    1352              ;                       mov xar7, xsp
    1352              ;                       mov sp, t0
    1352              ;                       mov ssp, t1
    1352              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1352              ;                       ar0 = *ar6
    1352              ;                       xssp = xar0
    1352              ;                       mov *xar6, xar0
    1352              ;                       mov xar0, xssp  ; stack now points to our TCB
    1352              ;;                      mov sp, *ar6
    1352              ;;                      mov sp, ar0
    1352              ;;                      mov sp, *_pxCurrentTCB
    1352              ;;                      clr ar0
    1352              ;;                      mov ar0, @xar6
    1352              ;;                      mov sp, AR0
    1352              ;;                      add sp, xar6
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   46

    1352              
    1352              ;;                      pshboth xar7
    1352              ;;                      pshboth xar6
    1352              ;;                      pshboth xar5
    1352              
    1352              ;;                      popboth xar5
    1352              ;;                      popboth xar6
    1352              ;;                      popboth xar7
    1352              
    1352              ;;;                     mov *sp(#1), ar7 
    1352              ;                       mov dbl(*sp(#1)), ar7
    1352              ;;;                     mov  ar7, mmap(ST1_55)
    1352              ; +++===+++
    1352 000366 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         000368 FF00 
         00036a 0000!
    1352 00036c EDE1                          mov dbl (*ar7), xsp                             ; xsp contains our TCB now
         00036e 4F   
    1352 00036f EDED                          mov dbl (*ar7(#2)), xssp
         000371 5F00 
         000373 02   
    1352              ; +++===+++
    1352                                      .if 0
    1352                                      mov *sp(#2), ar7
    1352                                      mov ar7, mmap(ST2_55)
    1352                                      mov ssp, ar7
    1352                                      mov *ar7(#2), ar6
    1352                                      mov ar6, mmap(ST0_55)
    1352                                      .endif
    1352              ;                       mov *ar7(#2), ar6
    1352              ;                       mov ar6, *ssp(#2)
    1352              ;                       mov *ssp(#2), ar7
    1352              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1352              ;
    1352              ; restore context
    1352              
    1352 000374 EC31                          amov #0x000000, xar2
         000376 AE00 
         000378 0000 
    1352 00037a EC31                          amov #0x000000, xar1
         00037c 9E00 
         00037e 0000 
    1352              
    1352 000380 AF06                          mov mmap(ST1_55), ar7
         000382 98   
    1352 000383 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         000385 FFFF 
    1352 000387 CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1352 000389 CF06                          mov ar7, mmap(ST1_55)
         00038b 98   
    1352              ;                       mov ar7, *ar4(#1)                       ; save in TCB
    1352 00038c AF96                          mov mmap(ST2_55), ar7
         00038e 98   
    1352 00038f CF04                          mov ar7, *sp(#2)
    1352              ;                       mov ar7, *ar4(#2)
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   47

    1352              
    1352 000391 449F                          mov ssp, ar7
    1352 000393 AE04                          mov mmap(ST0_55), ar6
         000395 98   
    1352 000396 CEED                          mov ar6, *ar7(#2)
         000398 0002 
    1352              ;                       mov ar6, *ar3(#2)
    1352 00039a AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         00039c 0000 
         00039e 00!  
    1352 00039f CEED                          mov ar6, *ar7(#1)
         0003a1 0001 
    1352              ;                       mov ar6, *ar3(#2)
    1352              
    1352              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
    1352              ;;                      and #0xFF00, ar6
    1352              ;;                      mov ar6, *ar7(#1)
    1352              
    1352 0003a3 ED08                          mov dbl(*sp(#4)), xar7
         0003a5 FF   
    1352              ;                       mov *sp(#1), ar7
    1352 0003a6 EB31                          mov xar7, dbl(*(#_usCriticalNesting))   
         0003a8 F500 
         0003aa 0000!
    1352              
    1352 0003ac ED0C                          mov dbl(*sp(#6)), xar6
         0003ae EF   
    1352              ;                       mov *sp(#3), ar6
    1352              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1352 0003af EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
         0003b1 E500 
         0003b3 0000!
    1352              ;                       POP XT
    1352                              ;-- Comment these to save cycles ---
    1352 0003b5 ED10                          mov dbl(*sp(#8)), xar7
         0003b7 FF   
    1352 0003b8 AF0E                          mov *sp(#7), ar7
    1352              ;                       mov *sp(#5), ar7
    1352              ;                       mov dbl(*sp(#0)), hi(ar7)
    1352              ;                       mov (*sp(#0)), lo(ar7)
    1352 0003ba ED14                          mov dbl(*sp(#10)), xar6
         0003bc EF   
    1352 0003bd AE12                          mov *sp(#9), ar6
    1352 0003bf ED18                          mov dbl(*sp(#12)), xar5
         0003c1 DF   
    1352 0003c2 AD16                          mov *sp(#11), ar5
    1352              ;; pvPararmeters currently here - needs to be verified --- jcw
    1352 0003c4 ED1C                          mov dbl(*sp(#14)), xar4
         0003c6 CF   
    1352 0003c7 AC1A                          mov *sp(#13), ar4
    1352 0003c9 ED20                          mov dbl(*sp(#16)), xar3
         0003cb BF   
    1352 0003cc AB1E                          mov *sp(#15), ar3
    1352 0003ce ED24                          mov dbl(*sp(#18)), xar2
         0003d0 AF   
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   48

    1352 0003d1 AA22                          mov *sp(#17), ar2
    1352 0003d3 ED28                          mov dbl(*sp(#20)), xar1
         0003d5 9F   
    1352 0003d6 A926                          mov *sp(#19), ar1
    1352 0003d8 ED2C                          mov dbl(*sp(#22)), xar0
         0003da 8F   
    1352 0003db A82A                          mov *sp(#21), ar0
    1352 0003dd ED30                      mov dbl(*sp(#24)), ac0
         0003df 08   
    1352 0003e0 A02E              mov *sp(#23), ac0
    1352              
    1352 0003e2 A732                          mov *sp(#25), t3
    1352 0003e4 A634                          mov *sp(#26), t2
    1352 0003e6 A536                          mov *sp(#27), t1
    1352 0003e8 A438                          mov *sp(#28), t0
    1352              
    1352              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1352              ;                       mov *sp(#21), *ssp
    1352              ;                       mov *sp(#21), RETA
    1352              ; need to move 23-16 to XSSP contents
    1352              ;                       mov xar0, dbl (*(#_save_xar7))
    1352              ;                       mov ssp, ar0
    1352              ;                       mov #0, ssp 
    1352              ;                       mov xssp, xar0
    1352              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1352              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1352                      ;               add #1, xssp            ; 32-bit return address pointer
    1352                      ;               amar *xssp+
    1352              ;                       mov sp, t0
    1352              ;                       add #1, t0
    1352              ;                       mov t0, ssp
    1352              ;                       incr ssp
    1352              ;                       asub #20, ar0
    1352              ;                       mov xar0, xssp
    1352              ;                       mov ar0, ssp
    1352              ;                       mov ar0, 
    1352              ;;                      mov *sp(#1), t0
    1352              ;;                      mov *sp(#3), t3         ; ST0
    1352              ;;                      mov *sp(#4), t2         ; DBSTAT
    1352              ;;                      mov t3, *ar0(#2)
    1352                      ;;              mov t2, *ar0(#1)
    1352              ;;                      mov t0, *ar0(#0)
    1352              
    1352              ;;                      mov *sp(#5), t0
    1352              ;;                      mov *sp(#6), t1
    1352              ;;                      mov *sp(#7), t2
    1352                      ;;              mov *sp(#8), t3
    1352              
    1352              ; restore ar0
    1352              ;                       mov dbl(*sp(#-2)), xar0
    1352              ;                       mov #-1, ar0
    1352              ;;                      mov dbl (*(#_save_xar7)), xar0
    1352              ;;
    1352              ;;                      mov sp, t0
    1352              ;;                      add #1, t0
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   49

    1352              ;;                      mov t0, ssp
    1352              
    1352              ;                       mov *sp(#3), *(#00004ch+#1)
    1352              
    1352              ;                       mov t3, *ssp(#1) 
    1352              ;                       mov t2, *ssp(#2)
    1352              
    1352              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1352              ;;                      mov t3, *(ssp(#0))
    1352              ;                       mov t3, *ssp
    1352              ;                       mov *sp(#3), t3 ; 
    1352              ;                       mov t3, *ssp(#1)
    1352              ;;                      mov *sp(#21), PC        
    1352              
    1352              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1352              ;                       mov dbl(xsp), dbl(lcrpc)
    1352              ;                       popboth XAR7
    1352              ;                       add #1, sp
    1352              ;                       add #1, ssp
    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352              ;                       popboth XAR6
    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352              ;                       popboth XAR5
    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352                              ;-----------------------------------
    1352              ;                       popboth XAR4
    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352              ;                       popboth XAR3
    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352              ;                       popboth XAR2
    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352              ;                       popboth XAR1
    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352              ;                       popboth XAR0
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   50

    1352              ;                       add #2, t0
    1352              ;                       add #2, t1
    1352              ;                       mov t0, sp
    1352              ;                       mov t1, ssp
    1352              ;                       EDIS
    1352              ;                       NASP    ; Un-align stack pointer
    1352              ;;                      pop mmap(ST3_55)
    1352              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1352              ;            BCC $2,TC1 ; |216|
    1352                                      .if 0
    1352                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1352              
    1352                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1352                                      mov dbl (*ar7(#2)), xssp                
    1352                                      .endif
    1352              
    1352 0003ea ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
         0003ec 4F00 
         0003ee 0000!
    1352 0003f0 ED31                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
         0003f2 5F00 
         0003f4 0000!
    1352              
    1352                                      .if 0
    1352                                      mov dbl (*(_xCompareTCB)), xar6
    1352              ; need to restore our return address
    1352                                      mov xar7, ac0
    1352                          mov xar6, ac1
    1352                              CMPU AC1 != AC0, TC1 ; |1393|
    1352                          BCC $6,TC1 ; |1393|
    1352                          amov #0x000000, xar7
    1352                                      amov #0x000000, xar6
    1352                          mov  *(#_save_new_pxcode), ar7
    1352                                      mov ar7, *sp(#0)
    1352                          mov *(#_save_new_pxlcode) , ar7
    1352                          mov ssp, ar6
    1352                          mov ar7, *ar6(#0)
    1352              
    1352                          mov dbl (*(#_save_xar6)), xar6
    1352                                      .endif
    1352              
    1352 0003f6 ED31                          mov dbl (*(#_save_xar7)), xar7
         0003f8 FF00 
         0003fa 0000!
    1352              
    1352              ;                       B $3
    1352              ;$2
    1352              ;           MOV #0, *(#_first_flag) ; |217|
    1352              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1352              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1352              ;$3
    1352              ;;                      aadd #1, sp
    1352 0003fc 46B2                          bclr INTM               ; enable interrupts
    1352              ;                       aadd #1, sp
    1352 0003fe 4805                          RETI
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   51

    1352              ;                       mov #1860h, ssp
    1352 000400 20                            nop
    1352 000401 20                            nop
    1352              ;                       nop
    1353              
    1354              ; /*-----------------------------------------------------------*/
    1355              
    1356              
    1357              ;/*
    1358              ; * Manual context switch called by the portYIELD() macro.
    1359              ; */
    1360              
    1361              ; We are using the slow return model:
    1362              
    1363              ; System Stack (SSP)                    Data Stack (SP)
    1364              ; SSP = x - 3:  (Loop Bits):PC(23-16)   SP = y - 3: PC(15-0)  <<= Last pushed - first to POP
    1365              ; SSP = x - 2:  DBSTAT                  SP = y - 2: ST1_55
    1366              ; SSP = x - 1:  ST0_55                  SP = y - 1: ST2_55
    1367              ; SSP = x:      Previously saved data   SP = y:     Previously saved data
    1368              
    1369              
    1370 000402       _vPortYield:                                    ;; note - most testing done with preemptive kernel - so this 
    1371              
    1372 000402 4EFF                  aadd #-1, sp
    1373 000404 E651                  MOV #0, *port(#6166) ; |119|
         000406 0018 
         000408 16   
    1374 000409 F402              AND #0x0010, mmap(@IFR0)
         00040b 0010 
         00040d 98   
    1375 00040e 46B3                  bset INTM
    1376              ;                /* Mimic an interrupt by pushing the SR. */
    1377              
    1378              ;               /* SR is 16-bits in 430X architecture */
    1379              
    1380              ;;                pushx.w    SR
    1381              
    1382              ;                /* Now the SR is stacked we can disable interrupts. */
    1383              
    1384              ;                dint
    1385              
    1386              ;                 bset INTM             ; disable interrupts
    1387              
    1388              ;;                bicx.w #0xF000,0(r1)
    1389              ;;                swpbx.w +4(r1)
    1390              ;;                rlax.w +4(r1)
    1391              ;;                rlax.w +4(r1)
    1392              ;;                rlax.w +4(r1)
    1393              ;;                rlax.w +4(r1)
    1394              ;;                addx.w +4(r1),0(r1)
    1395              ;;                movx.w +2(r1),+4(r1)
    1396              ;;                movx.w 0(r1),+2(r1)
    1397              ;;                incdx.a r1
    1398              
    1399              ;                /* Save the context of the current task. */
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   52

    1400              ;;        psh mmap(ST3_55)
    1401 ****** MACRO         portSAVE_CONTEXT
    1401              ;                       ;CONTEXT_SAVE
    1401              ;                       ASP  ; Align Stack Pointer
    1401              ;                       CLRC       OVM,PAGE0
    1401              ;                       CLRC       AMODE
    1401              ;                       EALLOW
    1401 000410 4652                  bclr C54CM      ; temp - until we figure out what is setting this
    1401              ;;;             bset INTM               ; disable interrupts - already done
    1401              ;                       aadd #1, sp
    1401              ;                       mov xsp,  dbl (*(#_save_xsp))                   ; save xsp
    1401              ;                       mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1401              ;;;                     mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
    1401              ;;;                     mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
    1401              
    1401              ;                       pshboth xar7
    1401              ;                       pshboth xar6
    1401              ;                       pshboth xar5
    1401              
    1401 000412 EB31                          mov xar7, dbl (*(#_save_xar7))                  ; save xar7
         000414 F500 
         000416 0000!
    1401              ;                       .if configUSE_CONTEXT_DEBUG == 1
    1401 000418 EB31                          mov xar6, dbl (*(#_save_xar6))
         00041a E500 
         00041c 0000!
    1401              ;                       .endif
    1401 00041e 4E01                          aadd #1, sp
    1401              ; +++===+++
    1401              
    1401                                      .if 0
    1401                                      amov #0x000000, xar7
    1401                                      amov #0x000000, xar6
    1401                                      mov xsp, xar7
    1401                                      mov xssp, xar6
    1401                                      amov #0x000000, xar2
    1401                                      amov #0x000000, xar1
    1401                                      mov dbl (*(#_pxCurrentTCB)), xar5
    1401              
    1401                                      mov dbl (*ar5), xar4                            ; xsp contains our TCB now
    1401                                      mov dbl (*ar5(#2)), xar3
    1401              
    1401                                      mov *ar7, ar2                           ; current xsp contents
    1401                                      mov *ar6, ar1                           ; current xssp contents
    1401              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1401                                      mov ar2, *ar4
    1401                                      mov ar1, *ar3
    1401                                      .endif
    1401              
    1401                                      .if 1
    1401              
    1401 000420 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         000422 FF00 
         000424 0000!
    1401 000426 EDA1                          mov dbl (*ar5), xsp                             ; xsp contains our TCB now
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   53

         000428 4F   
    1401 000429 EDAD                          mov dbl (*ar5(#2)), xssp
         00042b 5F00 
         00042d 02   
    1401 00042e EC31              amov #0x000000, xar7
         000430 FE00 
         000432 0000 
    1401 000434 EC31                          amov #0x000000, xar6
         000436 EE00 
         000438 0000 
    1401 00043a CF31              mov ar7, *(#_save_new_pxcode)
         00043c 0000 
         00043e 00!  
    1401 00043f 449E              mov ssp, ar6
    1401 000441 AFCD              mov *ar6(#1), ar7                                                       ;; ssp+3
         000443 0001 
    1401 000445 CF31              mov ar7, *(#_save_new_pxlcode)
         000447 0000 
         000449 00!  
    1401                                      .endif
    1401              
    1401              ;                       mov ssp, ar7
    1401              ;                       mov *ar7(#1), ar6                               ; this is (one)two away now
    1401              ;                       mov ar6, *(#_DBSTAT_SAVE)                       ; save DBSTAT
    1401              ;                       .endif
    1401              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1401              ;            mov xar6, dbl (*(#_save_xar6))                  ; save x
    1401                                      .if 0
    1401                                      amov #0x000000, xar7
    1401                                      amov #0x000000, xar6
    1401                          mov *sp(#0), ar7                                            ;; sp+3
    1401                          mov ar7, *(#_save_new_pxcode)
    1401                          mov ssp, ar6
    1401                          mov *ar6(#1), ar7                                                       ;; ssp+3
    1401                          mov ar7, *(#_save_new_pxlcode)       ;  ==> now we have our new return address, and if a task, it
    1401                                   ;   nop
    1401                          mov dbl (*(#_pxCurrentTCB)), xar7
    1401                          mov xar7, dbl(*(#_xCompareTCB))
    1401                          .endif
    1401              ; +++===+++
    1401              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1401              ;
    1401 00044a ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         00044c FF00 
         00044e 0000!
    1401 000450 EDE1                          mov dbl (*ar7), xsp                                     ; xsp contains our TCB now
         000452 4F   
    1401 000453 EDED                          mov dbl (*ar7(#2)), xssp
         000455 5F00 
         000457 02   
    1401              ; +++===+++
    1401                                      .if 0
    1401              ;                       mov dbl (*(_xCompareTCB)), xar6                 ; need to save our return address
    1401              ;                       mov xar7, ac0
    1401              ;               mov xar6, ac1
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   54

    1401              ;                       CMPU AC1 != AC0, TC1
    1401              ;                               BCC $5,TC1
    1401                                      amov #0x000000, xar7
    1401                                          amov #0x000000, xar6
    1401                                          mov  *(#_save_new_pxcode), ar7
    1401                                          mov ar7, *sp(#0)
    1401                              mov *(#_save_new_pxlcode) , ar7
    1401                              mov ssp, ar6
    1401                              mov ar7, *ar6(#0)
    1401                              mov dbl (*(#_save_xar6)), xar6
    1401                                         .endif
    1401              ; +++===+++
    1401 000458       $5_$4$:
    1401                                              
    1401              ; +++===+++
    1401              ;; what about xssp here?
    1401              ;;                              mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1401              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
    1401                                 .if configUSE_CONTEXT_DEBUG == 1
    1401              ;; save current PC (and possible loop bits values)
    1401              ;; for debug - to see if this is being corrupted
    1401                                      mov dbl(*ar7), xar6
    1401                                      mov dbl(*ar6), xar7
    1401                                      mov xar7, dbl (*(#_PC_REG_LOW_SAVE))            ; save off the PC
    1401                                      mov xssp, xar7
    1401                                      mov dbl(*ar7), xar6
    1401                                      mov dbl(*ar6), xar7
    1401                                      mov xar7, dbl (*(#_PC_REG_HIGH_SAVE))           ; save off the PC
    1401                                      mov xssp, xar7
    1401                                      add #-2, ar7
    1401                                      mov dbl(*ar7), xar6
    1401                                      mov xar6,  dbl (*(_DBSTAT_SAVE))
    1401                          mov dbl (*(#_save_xar6)), xar6
    1401              
    1401              ;            mov (*ar7), (*(#_PC_REG_LOW_SAVE))
    1401              ;            mov dbl(*xssp),(*(#_PC_REG_HIGH_SAVE))
    1401              ;                       mov (*ssp(#-2)), (*(#_DBSTAT_SAVE))
    1401                                      .endif
    1401              ; +++===+++
    1401                                      ; save context in our stack(s) frame
    1401              
    1401              ;;;;                    mov dbl (*(#_pxCurrentTCB)), xar7
    1401              ;;;                     mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1401              ;;;                     mov dbl (*ar7(#2)), xssp
    1401              ; +++===+++
    1401              
    1401 000458 ED31              mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
         00045a FF00 
         00045c 0000!
    1401 00045e ED31              mov dbl (*(#_save_xar6)), xar6
         000460 EF00 
         000462 0000!
    1401                                        ; restore xar6
    1401              ;;; begin context save:
    1401              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   55

    1401 000464 EB10                          mov xar7, dbl(*sp(#8))                          ; save xar7
         000466 F5   
    1401 000467 CF0E                          mov ar7, *sp(#7)
    1401              
    1401 000469 EB14                          mov xar6, dbl(*sp(#10))
         00046b E5   
    1401 00046c CE12                          mov ar6, *sp(#9)
    1401              
    1401 00046e EB18                          mov xar5, dbl(*sp(#12))
         000470 D5   
    1401 000471 CD16                          mov ar5, *sp(#11)
    1401              
    1401 000473 EB1C                          mov xar4, dbl(*sp(#14))
         000475 C5   
    1401 000476 CC1A                          mov ar4, *sp(#13)
    1401              
    1401 000478 EB20                          mov xar3, dbl(*sp(#16))
         00047a B5   
    1401 00047b CB1E                          mov ar3, *sp(#15)
    1401              
    1401 00047d EB24                          mov xar2, dbl(*sp(#18))
         00047f A5   
    1401 000480 CA22                          mov ar2, *sp(#17)
    1401              
    1401 000482 EB28                          mov xar1, dbl(*sp(#20))
         000484 95   
    1401 000485 C926                          mov ar1, *sp(#19)
    1401              
    1401 000487 EB2C                          mov xar0, dbl(*sp(#22))
         000489 85   
    1401 00048a C82A                          mov ar0, *sp(#21)
    1401              
    1401 00048c EB30              mov  ac0, dbl(*sp(#24))
         00048e 08   
    1401 00048f C02E              mov ac0, *sp(#23)
    1401              
    1401 000491 C732                          mov t3, *sp(#25)
    1401 000493 C634                          mov t2, *sp(#26)
    1401 000495 C536                          mov t1, *sp(#27)
    1401 000497 C438                          mov t0, *sp(#28)
    1401              ; +++===+++
    1401              ;;                      mov mmap(ST0_55), t0
    1401              ; - this is ok - we are not pushing - it's a relative stack frame
    1401              ;                       mov t0, *sp(#25)
    1401              ;;                      mov t0, *sp(#23)
    1401              ;;                      mov mmap(ST1_55), t1
    1401              ;                       mov t1, *sp(#26)                ; stomping on own mem
    1401              ;;                      mov t1, *sp(#21)                ; stomping on own mem
    1401              ;;                      mov mmap(ST2_55), t2
    1401              ;;                      mov t2, *sp(#22)
    1401              ;                       mov t2, *sp(#27)
    1401              ;;                      mov mmap(ST2_55), t3
    1401              ;                       mov t3, *sp(#28)
    1401              ;;                      mov t3, *sp(#24)
    1401              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   56

    1401              ;                       PSH dbl(AR0) ; 32-bit
    1401              ;                       PSH dbl(AR1) 
    1401              ;                       PSH dbl(AR2) ; 32-bit
    1401              ;                       PUSH XAR3 ; 32-bit
    1401              ;                       PUSH XAR4 ; 32-bit
    1401                              ;-- Comment these to save cycles --------
    1401              ;                       PUSH XAR5 ; 32-bit
    1401              ;                       PUSH XAR6 ; 32-bit
    1401              ;                       PUSH XAR7 ; 32-bit
    1401                              ;----------------------------------------
    1401              
    1401              ;                       PUSH XT   ; 32-bit
    1401              
    1401              ;                       movl xar6, @_portFLAGS_INT_ENABLED
    1401              ;                       push xar6 ; portFLAGS_INT_ENABLED
    1401              ; +++===+++
    1401              
    1401 000499 ED31                          mov dbl (*(#_portFLAGS_INT_ENABLED)), xar6
         00049b EF00 
         00049d 0000!
    1401 00049f EB0C                          mov xar6, dbl(*sp(#6))
         0004a1 E5   
    1401                                      
    1401              
    1401              ;                       movl xar7, @_usCriticalNesting
    1401              ;                       push xar7
    1401 0004a2 ED31                          mov dbl (*(#_usCriticalNesting)), xar7
         0004a4 FF00 
         0004a6 0000!
    1401 0004a8 EB08                          mov xar7, dbl(*sp(#4))
         0004aa F5   
    1401              
    1401 0004ab EC31                          amov #0x000000, xar7
         0004ad FE00 
         0004af 0000 
    1401 0004b1 EC31                          amov #0x000000, xar6
         0004b3 EE00 
         0004b5 0000 
    1401              
    1401 0004b7 AF06                          mov mmap(ST1_55), ar7
         0004b9 98   
    1401 0004ba CF02                          mov ar7, *sp(#1)
    1401 0004bc AF96                          mov  mmap(ST2_55), ar7
         0004be 98   
    1401 0004bf CF04                          mov ar7, *sp(#2)
    1401              
    1401 0004c1 449F                          mov ssp, ar7
    1401              ;                       mov *(#_LOOP_BITS), ar6                 ; save LOOP_BITS (CFCT)
    1401              ;                       and #0xFF00, ar6
    1401              ;                       mov ar6, *ar7(#1)
    1401              
    1401 0004c3 AE04                          mov mmap(ST0_55), ar6
         0004c5 98   
    1401 0004c6 CEED                          mov ar6, *ar7(#2)
         0004c8 0002 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   57

    1401                                      
    1401 0004ca AE31                          mov *(#_DBSTAT_SAVE), ar6               ; save DBSTAT
         0004cc 0000 
         0004ce 00!  
    1401 0004cf CEED                          mov ar6, *ar7(#1)
         0004d1 0001 
    1401              ; +++===+++
    1401              ;                       mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
    1401              ;                       mov dbl (*(#_save_xssp)), xssp          
    1401              ;;;                     mov  dbl (*(_DBSTAT_SAVE)), *xar7(#2)   ; needs to be DBSTAT - don't overwrite DBSTAT
    1401              ;;;                     mov ar6, *ar7(#2)
    1401              ;                       mov ar7, mmap(ST0_55)
    1401              ;                       mov *ssp(#2), ar7
    1401              ; fix up
    1401              ;                       aadd #20, sp
    1401              ;                       mov sp, t0
    1401              ;                       sub #1, t0
    1401              ;                       mov t0, ssp
    1401              
    1401                                      ; move contents of SP into address of current TCB
    1401              ;                       mov xsp, dbl (*(#_pxCurrentTCB))                ; xsp contains our TCB now
    1401              
    1401              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1401              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1401              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1401              ;                       mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1401              ;                       mov dbl (*ar7+), xssp
    1401              
    1401              ;                       mov sp, t0              ; we've already saved t0
    1401              ;                       add #1, t0
    1401              ;                       mov t0, ssp
    1401              ; ??
    1401              ;                       mov xsp, dbl (*(#_pxCurrentTCB))
    1401              
    1401              ;                       movl xar6, @_pxCurrentTCB ; XAR6 contains current TCB addr
    1401              ;                       mov al, @sp
    1401              ;                       movl  *xar6, acc        
    1401              ;;                      mov  ar0, @sp
    1401              ;;                      mov  @ar6, alxd
    1401              ;;                      mov  ar0, @sp
    1401              ;;                      movl 0(xar6), sp
    1401              ;                       EDIS
    1401              ;                       NASP
    1401              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1401              ;                       NOP
    1401 0004d3 ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp*
         0004d5 4F00 
         0004d7 0000!
    1401 0004d9 ED31                          mov dbl (*(#_save_xssp)), xssp                  ; restore xssp
         0004db 5F00 
         0004dd 0000!
    1401 0004df 20                            nop
    1401              ;                       aadd #-1, sp
    1401 0004e0 20                            nop
    1401              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   58

    1401 0004e1 20                            nop
    1401                                                                                      ; ?
    1402              
    1403              ;        /* Switch to the highest priority task that is ready to run. */
    1404 0004e2 6C00          call    #_vTaskSwitchContext
         0004e4 0000!
    1405              
    1406              
    1407 0004e6 E651          mov #1, *port(#6166) ; |127|
         0004e8 0118 
         0004ea 16   
    1408 0004eb F551                  or #0x0001, *port(#7188) ; |130|
         0004ed 0001 
         0004ef 1C14 
    1409 0004f1 4E01                  aadd #1, sp
    1410 ****** MACRO         portRESTORE_CONTEXT
    1410                                      .C54CM_off
    1410              ;                       .CPL_off
    1410                                      .ARMS_off
    1410                                      .align 4
    1410              
    1410              ; Restore context & return
    1410                                      ;CONTEXT_RESTORE
    1410              ;                       ASP
    1410              ;                       EALLOW
    1410              ;                       nop
    1410              ;                       nop
    1410              ;                       nop
    1410              ;                       nop
    1410 0004f4 4652                  bclr C54CM
    1410              ;               xssp = dbl(*(#_pxCurrentTCB))
    1410              ;               xsp  = dbl(*(#_pxCurrentTCB))
    1410 0004f6 EB31                          mov xar7, dbl (*(#_save_xar7))  
         0004f8 F500 
         0004fa 0000!
    1410 0004fc EB31                          mov xar6, dbl (*(#_save_xar6))
         0004fe E500 
         000500 0000!
    1410              
    1410 000502 4EFF                          aadd #-1, sp
    1410              ;            aadd #-3, xsp
    1410              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1410              ;            BCC $1,TC1 ; |216|
    1410 000504 ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
         000506 4F00 
         000508 0000!
    1410 00050a ED31                          mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
         00050c 5F00 
         00050e 0000!
    1410              ;            B $4
    1410              ;;                      mov xsp, dbl (*(#_save_xsp))                    ; save xsp
    1410              ;;                      mov xssp, dbl (*(#_save_xssp))                  ; save xssp
    1410              
    1410              ;;                      aadd #1, sp
    1410              ;$1
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   59

    1410              ;                       mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1410              ;                       mov dbl (*(#_first_save_xssp)), xssp                    ; restore xssp
    1410              ;$4
    1410                                      .if 1
    1410 000510 904F                          mov xsp, xar7
    1410 000512 905E                          mov xssp, xar6
    1410 000514 EC31                          amov #0x000000, xar2
         000516 AE00 
         000518 0000 
    1410 00051a EC31                          amov #0x000000, xar1
         00051c 9E00 
         00051e 0000 
    1410 000520 ED31                          mov dbl (*(#_pxCurrentTCB)), xar5                       
         000522 DF00 
         000524 0000!
    1410              
    1410 000526 EDA1                          mov dbl (*ar5), xar4                            ; xsp contains our TCB now
         000528 CF   
    1410 000529 EDAD                          mov dbl (*ar5(#2)), xar3                        
         00052b BF00 
         00052d 02   
    1410                                      
    1410 00052e AA81                          mov *ar4, ar2
    1410 000530 A961                          mov *ar3, ar1
    1410              ;                       mov ar4, *ar6                           ; stack pointers fixed up
    1410 000532 CAE1                          mov ar2, *ar7
    1410 000534 C9C1                          mov ar1, *ar6
    1410              
    1410 000536 AF06                          mov mmap(ST1_55), ar7
         000538 98   
    1410 000539 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         00053b FFFF 
    1410 00053d CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1410 00053f CF8D                          mov ar7, *ar4(#1)                       ; save in TCB
         000541 0001 
    1410 000543 AF96                          mov mmap(ST2_55), ar7
         000545 98   
    1410 000546 CF04                          mov ar7, *sp(#2)
    1410 000548 CF8D                          mov ar7, *ar4(#2)
         00054a 0002 
    1410              
    1410 00054c 449F                          mov ssp, ar7
    1410 00054e AE04                          mov mmap(ST0_55), ar6
         000550 98   
    1410 000551 CEED                          mov ar6, *ar7(#2)
         000553 0002 
    1410 000555 CE6D                          mov ar6, *ar3(#2)
         000557 0002 
    1410 000559 AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         00055b 0000 
         00055d 00!  
    1410 00055e CEED                          mov ar6, *ar7(#1)
         000560 0001 
    1410 000562 CE6D                          mov ar6, *ar3(#1)
         000564 0001 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   60

    1410                                      .endif
    1410              
    1410              ;                       mov #0, ssp     
    1410              ;                       mov xar7, dbl (*(#_save_xar7))                  ; save xar7 
    1410              ;                       mov dbl (*(#_pxCurrentTCB)), xar7
    1410                                      ; 32-bit mode - will act on SP and SSP:
    1410              ;                       'fix-up' current SP and SSP - is this dangerous????
    1410              ;                       aadd #-3, sp
    1410              ;;                      mov *ar7, *sp
    1410              ;                       mov dbl (*ar7), ar6
    1410              ;                       mov ar6, *sp                            ; xsp contains our TCB now
    1410              ;                       mov *ar7(#2), *ssp                      
    1410              ;                       POP mmap(ST3_55)
    1410              ;                       pshboth xar7                            ; should increment both
    1410                                      .if 0
    1410                                      mov mmap(ST1_55), ar7
    1410                                      and #0xf7ff, ar7                        ; <here>#0800h
    1410                                      mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1410                                      mov mmap(ST2_55), ar7
    1410                                      mov ar7, *sp(#2)
    1410              
    1410                                      mov ssp, ar7
    1410                                      mov mmap(ST0_55), ar6
    1410                                      mov ar6, *ar7(#2)
    1410              ;;                      mov mmap(ST0_55), ar6   ; needs to be DBSTAT
    1410              ;;                      mov ar6, *ar7(#1)
    1410                                      .endif
    1410              ; +++===+++
    1410                                      .if 0
    1410                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1410                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1410                                      mov dbl (*ar7(#2)), xssp        
    1410                                      .endif
    1410              ; +++===+++
    1410                                      .if 0
    1410                                      mov dbl (*(_xCompareTCB)), xar6
    1410              ; need to restore our return address
    1410                                      mov xar7, ac0
    1410                                          mov xar6, ac1
    1410                                          CMPU AC1 != AC0, TC1 ; |1393|
    1410                                          BCC $6,TC1 ; |1393|
    1410                                          amov #0x000000, xar7
    1410                                          amov #0x000000, xar6
    1410                                          mov  *(#_save_new_pxcode), ar7
    1410                                          mov ar7, *sp(#0)
    1410                                          mov *(#_save_new_pxlcode) , ar7
    1410                                          mov ssp, ar6
    1410                                          mov ar7, *ar6(#0)
    1410              
    1410                                          mov dbl (*(#_save_xar6)), xar6
    1410                                                              .endif
    1410              ; +++===+++
    1410 000566       $6_$5$:
    1410              ;;                mov xsp, dbl (*(#_save_xsp))                  ; save xsp
    1410              ;;                          mov xssp, dbl (*(#_save_xssp))                      ; save xssp
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   61

    1410                                      .if configUSE_CONTEXT_RESTORE_DEBUG == 1
    1410                                      mov xar7, dbl (*(#_save_xar7))                  ; save xar7
    1410                                      mov xar6, dbl (*(#_save_xar6))
    1410              
    1410              ;; this is for debug
    1410                                      mov dbl(*ar7), xar6
    1410                                      mov dbl(*ar6), xar7
    1410                                      mov xar7, dbl (*(#_PC_REG_LOW_RESTORE))         ; save off the PC
    1410                                      mov xssp, xar7
    1410                                      mov dbl(*ar7), xar6
    1410                                      mov dbl(*ar6), xar7
    1410                                      mov xar7, dbl (*(#_PC_REG_HIGH_RESTORE))                ; save off the PC
    1410                                      mov xssp, xar7
    1410                                      add #-2, ar7
    1410                                      mov dbl(*ar7), xar6
    1410                                      mov xar6,  dbl (*(_DBSTAT_RESTORE))
    1410                                      mov dbl (*(#_save_xar6)), xar6
    1410                                      
    1410                                      mov dbl (*(#_save_xar7)), xar7                  ; restore xar7
    1410                                      .endif
    1410              ; +++===+++
    1410              ;                       mov mmap(ST0_55), *ssp(#1)
    1410              ;                       mov mmap(STO_55), *ssp(#2)
    1410              ;                       mov mmap(ST1_55), *sp(#1)
    1410              ;                       mov mmap(ST2_55), *sp(#2)               ; needs to be DBSTAT                    
    1410              ;                       mov *ar7, t0
    1410              ;                       mov t0, *sp(#0)                         ; xsp contains our TCB now
    1410              ;                       mov *ar7(#2), t0
    1410              ;                       mov t0, *ssp(#0)                        
    1410              
    1410              ;                       mov  (*ar7), sp                                 ; xsp contains our TCB now
    1410              ; what about xssp?
    1410              ;                       mov xar6, xsp
    1410              ;                       mov xssp, xar7
    1410              ;                       add #1, ar7
    1410              ;                       mov xar7, xsp
    1410              ;                       mov sp, t0
    1410              ;                       mov ssp, t1
    1410              ;                       mov dbl(*(#_pxCurrentTCB)), xsp
    1410              ;                       ar0 = *ar6
    1410              ;                       xssp = xar0
    1410              ;                       mov *xar6, xar0
    1410              ;                       mov xar0, xssp  ; stack now points to our TCB
    1410              ;;                      mov sp, *ar6
    1410              ;;                      mov sp, ar0
    1410              ;;                      mov sp, *_pxCurrentTCB
    1410              ;;                      clr ar0
    1410              ;;                      mov ar0, @xar6
    1410              ;;                      mov sp, AR0
    1410              ;;                      add sp, xar6
    1410              
    1410              ;;                      pshboth xar7
    1410              ;;                      pshboth xar6
    1410              ;;                      pshboth xar5
    1410              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   62

    1410              ;;                      popboth xar5
    1410              ;;                      popboth xar6
    1410              ;;                      popboth xar7
    1410              
    1410              ;;;                     mov *sp(#1), ar7 
    1410              ;                       mov dbl(*sp(#1)), ar7
    1410              ;;;                     mov  ar7, mmap(ST1_55)
    1410              ; +++===+++
    1410 000566 ED31                          mov dbl (*(#_pxCurrentTCB)), xar7
         000568 FF00 
         00056a 0000!
    1410 00056c EDE1                          mov dbl (*ar7), xsp                             ; xsp contains our TCB now
         00056e 4F   
    1410 00056f EDED                          mov dbl (*ar7(#2)), xssp
         000571 5F00 
         000573 02   
    1410              ; +++===+++
    1410                                      .if 0
    1410                                      mov *sp(#2), ar7
    1410                                      mov ar7, mmap(ST2_55)
    1410                                      mov ssp, ar7
    1410                                      mov *ar7(#2), ar6
    1410                                      mov ar6, mmap(ST0_55)
    1410                                      .endif
    1410              ;                       mov *ar7(#2), ar6
    1410              ;                       mov ar6, *ssp(#2)
    1410              ;                       mov *ssp(#2), ar7
    1410              ;                       mov ar6, mmap(ST0_55)   ; needs to be DBSTAT
    1410              ;
    1410              ; restore context
    1410              
    1410 000574 EC31                          amov #0x000000, xar2
         000576 AE00 
         000578 0000 
    1410 00057a EC31                          amov #0x000000, xar1
         00057c 9E00 
         00057e 0000 
    1410              
    1410 000580 AF06                          mov mmap(ST1_55), ar7
         000582 98   
    1410 000583 7DF7                          and #0xf7ff, ar7                        ; <here>#0800h
         000585 FFFF 
    1410 000587 CF02                          mov ar7, *sp(#1)                        ; need to make sure IRQ bit is enabled here
    1410 000589 CF06                          mov ar7, mmap(ST1_55)
         00058b 98   
    1410              ;                       mov ar7, *ar4(#1)                       ; save in TCB
    1410 00058c AF96                          mov mmap(ST2_55), ar7
         00058e 98   
    1410 00058f CF04                          mov ar7, *sp(#2)
    1410              ;                       mov ar7, *ar4(#2)
    1410              
    1410 000591 449F                          mov ssp, ar7
    1410 000593 AE04                          mov mmap(ST0_55), ar6
         000595 98   
    1410 000596 CEED                          mov ar6, *ar7(#2)
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   63

         000598 0002 
    1410              ;                       mov ar6, *ar3(#2)
    1410 00059a AE31                          mov *(#_DBSTAT_SAVE), ar6               ; have to restore this
         00059c 0000 
         00059e 00!  
    1410 00059f CEED                          mov ar6, *ar7(#1)
         0005a1 0001 
    1410              ;                       mov ar6, *ar3(#2)
    1410              
    1410              ;;                      mov *(#_LOOP_BITS), ar6         ; have to restore this
    1410              ;;                      and #0xFF00, ar6
    1410              ;;                      mov ar6, *ar7(#1)
    1410              
    1410 0005a3 ED08                          mov dbl(*sp(#4)), xar7
         0005a5 FF   
    1410              ;                       mov *sp(#1), ar7
    1410 0005a6 EB31                          mov xar7, dbl(*(#_usCriticalNesting))   
         0005a8 F500 
         0005aa 0000!
    1410              
    1410 0005ac ED0C                          mov dbl(*sp(#6)), xar6
         0005ae EF   
    1410              ;                       mov *sp(#3), ar6
    1410              ;                       popboth xar6 ; portFLAGS_INT_ENABLED
    1410 0005af EB31                          mov xar6, dbl(*(#_portFLAGS_INT_ENABLED))       
         0005b1 E500 
         0005b3 0000!
    1410              ;                       POP XT
    1410                              ;-- Comment these to save cycles ---
    1410 0005b5 ED10                          mov dbl(*sp(#8)), xar7
         0005b7 FF   
    1410 0005b8 AF0E                          mov *sp(#7), ar7
    1410              ;                       mov *sp(#5), ar7
    1410              ;                       mov dbl(*sp(#0)), hi(ar7)
    1410              ;                       mov (*sp(#0)), lo(ar7)
    1410 0005ba ED14                          mov dbl(*sp(#10)), xar6
         0005bc EF   
    1410 0005bd AE12                          mov *sp(#9), ar6
    1410 0005bf ED18                          mov dbl(*sp(#12)), xar5
         0005c1 DF   
    1410 0005c2 AD16                          mov *sp(#11), ar5
    1410              ;; pvPararmeters currently here - needs to be verified --- jcw
    1410 0005c4 ED1C                          mov dbl(*sp(#14)), xar4
         0005c6 CF   
    1410 0005c7 AC1A                          mov *sp(#13), ar4
    1410 0005c9 ED20                          mov dbl(*sp(#16)), xar3
         0005cb BF   
    1410 0005cc AB1E                          mov *sp(#15), ar3
    1410 0005ce ED24                          mov dbl(*sp(#18)), xar2
         0005d0 AF   
    1410 0005d1 AA22                          mov *sp(#17), ar2
    1410 0005d3 ED28                          mov dbl(*sp(#20)), xar1
         0005d5 9F   
    1410 0005d6 A926                          mov *sp(#19), ar1
    1410 0005d8 ED2C                          mov dbl(*sp(#22)), xar0
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   64

         0005da 8F   
    1410 0005db A82A                          mov *sp(#21), ar0
    1410 0005dd ED30                      mov dbl(*sp(#24)), ac0
         0005df 08   
    1410 0005e0 A02E              mov *sp(#23), ac0
    1410              
    1410 0005e2 A732                          mov *sp(#25), t3
    1410 0005e4 A634                          mov *sp(#26), t2
    1410 0005e6 A536                          mov *sp(#27), t1
    1410 0005e8 A438                          mov *sp(#28), t0
    1410              
    1410              ;                       mov dbl(*sp(#21)), *xssp(#0)
    1410              ;                       mov *sp(#21), *ssp
    1410              ;                       mov *sp(#21), RETA
    1410              ; need to move 23-16 to XSSP contents
    1410              ;                       mov xar0, dbl (*(#_save_xar7))
    1410              ;                       mov ssp, ar0
    1410              ;                       mov #0, ssp 
    1410              ;                       mov xssp, xar0
    1410              ;                       mov dbl (*(#_save_xsp)), xar0                   ; save xsp
    1410              ;                       aadd #20, sp            ; this is ok - ssp also incremented
    1410                      ;               add #1, xssp            ; 32-bit return address pointer
    1410                      ;               amar *xssp+
    1410              ;                       mov sp, t0
    1410              ;                       add #1, t0
    1410              ;                       mov t0, ssp
    1410              ;                       incr ssp
    1410              ;                       asub #20, ar0
    1410              ;                       mov xar0, xssp
    1410              ;                       mov ar0, ssp
    1410              ;                       mov ar0, 
    1410              ;;                      mov *sp(#1), t0
    1410              ;;                      mov *sp(#3), t3         ; ST0
    1410              ;;                      mov *sp(#4), t2         ; DBSTAT
    1410              ;;                      mov t3, *ar0(#2)
    1410                      ;;              mov t2, *ar0(#1)
    1410              ;;                      mov t0, *ar0(#0)
    1410              
    1410              ;;                      mov *sp(#5), t0
    1410              ;;                      mov *sp(#6), t1
    1410              ;;                      mov *sp(#7), t2
    1410                      ;;              mov *sp(#8), t3
    1410              
    1410              ; restore ar0
    1410              ;                       mov dbl(*sp(#-2)), xar0
    1410              ;                       mov #-1, ar0
    1410              ;;                      mov dbl (*(#_save_xar7)), xar0
    1410              ;;
    1410              ;;                      mov sp, t0
    1410              ;;                      add #1, t0
    1410              ;;                      mov t0, ssp
    1410              
    1410              ;                       mov *sp(#3), *(#00004ch+#1)
    1410              
    1410              ;                       mov t3, *ssp(#1) 
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   65

    1410              ;                       mov t2, *ssp(#2)
    1410              
    1410              ;;                      mov *sp(#1), dbl(*(#_save_xsp)) 
    1410              ;;                      mov t3, *(ssp(#0))
    1410              ;                       mov t3, *ssp
    1410              ;                       mov *sp(#3), t3 ; 
    1410              ;                       mov t3, *ssp(#1)
    1410              ;;                      mov *sp(#21), PC        
    1410              
    1410              ;; ;;                   mov dbl (*(#_save_xsp)), xsp    ; restore xsp           
    1410              ;                       mov dbl(xsp), dbl(lcrpc)
    1410              ;                       popboth XAR7
    1410              ;                       add #1, sp
    1410              ;                       add #1, ssp
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410              ;                       popboth XAR6
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410              ;                       popboth XAR5
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410                              ;-----------------------------------
    1410              ;                       popboth XAR4
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410              ;                       popboth XAR3
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410              ;                       popboth XAR2
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410              ;                       popboth XAR1
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410              ;                       popboth XAR0
    1410              ;                       add #2, t0
    1410              ;                       add #2, t1
    1410              ;                       mov t0, sp
    1410              ;                       mov t1, ssp
    1410              ;                       EDIS
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   66

    1410              ;                       NASP    ; Un-align stack pointer
    1410              ;;                      pop mmap(ST3_55)
    1410              ;            CMP *(#_first_flag) == #1, TC1 ; |216|
    1410              ;            BCC $2,TC1 ; |216|
    1410                                      .if 0
    1410                                      mov dbl (*(#_pxCurrentTCB)), xar7
    1410              
    1410                                      mov dbl (*ar7), xsp                             ; xsp contains our TCB now
    1410                                      mov dbl (*ar7(#2)), xssp                
    1410                                      .endif
    1410              
    1410 0005ea ED31                          mov dbl (*(#_save_xsp)), xsp                    ; restore xsp***
         0005ec 4F00 
         0005ee 0000!
    1410 0005f0 ED31                  mov dbl (*(#_save_xssp)), xssp                  ; restore xssp***
         0005f2 5F00 
         0005f4 0000!
    1410              
    1410                                      .if 0
    1410                                      mov dbl (*(_xCompareTCB)), xar6
    1410              ; need to restore our return address
    1410                                      mov xar7, ac0
    1410                          mov xar6, ac1
    1410                              CMPU AC1 != AC0, TC1 ; |1393|
    1410                          BCC $6,TC1 ; |1393|
    1410                          amov #0x000000, xar7
    1410                                      amov #0x000000, xar6
    1410                          mov  *(#_save_new_pxcode), ar7
    1410                                      mov ar7, *sp(#0)
    1410                          mov *(#_save_new_pxlcode) , ar7
    1410                          mov ssp, ar6
    1410                          mov ar7, *ar6(#0)
    1410              
    1410                          mov dbl (*(#_save_xar6)), xar6
    1410                                      .endif
    1410              
    1410 0005f6 ED31                          mov dbl (*(#_save_xar7)), xar7
         0005f8 FF00 
         0005fa 0000!
    1410              
    1410              ;                       B $3
    1410              ;$2
    1410              ;           MOV #0, *(#_first_flag) ; |217|
    1410              ;               mov dbl (*(#_first_save_xsp)), xsp                      ; restore xsp
    1410              ;                       mov dbl (*(#_first_save_xssp)), xssp
    1410              ;$3
    1410              ;;                      aadd #1, sp
    1410 0005fc 46B2                          bclr INTM               ; enable interrupts
    1410              ;                       aadd #1, sp
    1410 0005fe 4805                          RETI
    1410              ;                       mov #1860h, ssp
    1410 000600 20                            nop
    1410 000601 20                            nop
    1410              ;                       nop
    1411              
TMS320C55x Assembler PC v4.4.1 Sat Sep 22 20:47:24 2018

Tools Copyright (c) 1996-2012 Texas Instruments Incorporated
..\FreeRTOS\Source\portable\CCS\c55x\portASM.asm                     PAGE   67

    1412              ;;;
    1413              
    1414              ;                /* Place the tick ISR in the correct vector. */
    1415              
    1416              ;;;                .sect ".int49"                       ; TIMER1_A0_VECTOR
    1417              ;;                .sect ".int14"                        ; CPUTIMER2
    1418              ;                 .sect ".text"                 ; CPUTIMER2
    1419              ;;;;             .sect ".INT14_ISR"
    1420              ;               .global _INT14_ISR
    1421              ;;;; _INT14_ISR:
    1422              ;;;;                .short   _vTickISR
    1423              ;;;;            LCR #_vTickISR
    1424                                      .end

No Assembly Errors, No Assembly Warnings
